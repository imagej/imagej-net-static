<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>BUnwarpJ - ImageJ</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"BUnwarpJ","wgTitle":"BUnwarpJ","wgCurRevisionId":40862,"wgRevisionId":40862,"wgArticleId":191,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Plugins","Registration","Citable"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"BUnwarpJ","wgRelevantArticleId":191,"wgRequestId":"c13a6847ff09d5a7ed8dcfd3","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgPreferredVariant":"en","fancytree_path":"/extensions/TreeAndMenu/fancytree"});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user.cssprefs":"ready","user":"ready","user.options":"loading","user.tokens":"loading","ext.math.styles":"ready","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","skins.erudite":"ready"});mw.loader.implement("user.options@0j3lz3q",function($,jQuery,require,module){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens@1ku9xth",function ( $, jQuery, require, module ) {
mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});/*@nomin*/;

});mw.loader.load(["mediawiki.page.startup"]);});</script>
<link rel="stylesheet" href="erudite5.css"/>
<link rel="stylesheet" href="extensions/TreeAndMenu/fancytree/fancytree.css"/><link rel="stylesheet" href="extensions/TreeAndMenu/suckerfish/suckerfish.css"/>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="erudite15.css"/>
<meta name="generator" content="MediaWiki 1.28.0"/>
<meta name="description" content="This ImageJ/Fiji plugin performs 2D image registration based on elastic deformations represented by B-splines. The invertibility of the deformations is enforced through a consistency restriction."/>
<link rel="shortcut icon" href="skins/ij2.ico"/>

<script type="text/javascript" src="extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushJava.js"></script>
<script type="text/javascript" src="extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushPlain.js"></script>
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<link rel="stylesheet" type="text/css" media="screen" href="extensions/SyntaxHighlighter/syntaxhighlighter/styles/shCoreMinit.css" />

	<meta property="og:type" content="article"/>

	<meta property="og:site_name" content="ImageJ"/>

	<meta property="og:title" content="BUnwarpJ"/>

	<meta property="og:description" content="This ImageJ/Fiji plugin performs 2D image registration based on elastic deformations represented by B-splines. The invertibility of the deformations is enforced through a consistency restriction."/>


<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-BUnwarpJ rootpage-BUnwarpJ skin-erudite action-view">
		<div id="top-wrap" role="banner">
			<h1><a href="Welcome" title="ImageJ" rel="home">ImageJ</a></h1>
			<div id="tagline">From ImageJ</div>

			<a id="menubutton" href="BUnwarpJ.html#menu">Menu</a>
			<div id="nav" role="navigation">
			<ul id='menu'>
<li id="menu-item-n-About"><a href="ImageJ">About</a></li>
<li id="menu-item-n-Downloads"><a href="Downloads">Downloads</a></li>
<li id="menu-item-n-Learn"><a href="Learn">Learn</a></li>
<li id="menu-item-n-Develop"><a href="Development">Develop</a></li>
<li id="menu-item-n-News"><a href="News">News</a></li>
<li id="menu-item-n-Events"><a href="Events">Events</a></li>
<li id="menu-item-n-Help"><a href="Help">Help</a></li>
</ul>
			</div>
		</div>

		<div id="mw-js-message"></div>
		
		<div id="main" role="main">

			<div id="bodyContent">
				<div style="font-size: large; border: 1px solid black; padding: 1em; margin-bottom: 1em; text-align: center; background-color: #fda;">
					This is an archive of the old MediaWiki-based ImageJ wiki. The current website can be found at <a href="https://imagej.net/">imagej.net</a>.
				</div>

				<h1>BUnwarpJ</h1>
				
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><table class="infobox" cellspacing="5" style="max-width: 30em; font-size: 80%; text-align: left; float: right; border: 1px solid #a0a0a0;">
<tr>
<th colspan="2" style="text-align: center; font-size: 130%;"> <div style="float: left"></div>bUnwarpJ<div style="clear: left;"></div>
</th></tr>
<tr>
<th> Project
</th>
<td> Fiji
</td></tr>
<tr>
<th> URL
</th>
<td> <a rel="nofollow" class="external free" href="BUnwarpJ">https://imagej.net/BUnwarpJ</a>
</td></tr>
<tr>
<th> Source
</th>
<td> <a rel="nofollow" class="external text" href="https://github.com/fiji/bUnwarpJ/releases/tag/bUnwarpJ_-2.6.8">on GitHub</a>
</td></tr>
<tr>
<th> License
</th>
<td> <a href="GPLv3" class="mw-redirect" title="GPLv3">GPLv3</a>
</td></tr>
<tr>
<th> Release
</th>
<td> <a rel="nofollow" class="external text" href="http://maven.imagej.net/index.html#nexus-search;gav~sc.fiji~bUnwarpJ_~2.6.8~~~kw,versionexpand">2.6.8</a>
</td></tr>
<tr>
<th> Date
</th>
<td> Fri May 19 09:28:54 CDT 2017
</td></tr>
<tr>
<th> <a href="Development_status" class="mw-redirect" title="Development status">Development status</a>
</th>
<td> Stable
</td></tr>
<tr>
<th> <a href="Support_status" class="mw-redirect" title="Support status">Support status</a>
</th>
<td> Active
</td></tr>
<tr>
<th colspan="2" style="background: lightgray; font-variant: small-caps; text-align: center"> <a href="Team" class="mw-redirect" title="Team">Team</a>
</th></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Founders</a>
</th>
<td> <a href="./User:Iarganda" title="User:Iarganda">Ignacio Arganda-Carreras</a>, <a rel="nofollow" class="external text" href="https://github.com/jkybic">Jan Kybic</a>, <a href="./User:Albertcardona" title="User:Albertcardona">Albert Cardona</a>
</td></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Leads</a>
</th>
<td> <a href="./User:Iarganda" title="User:Iarganda">Ignacio Arganda-Carreras</a>
</td></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Developers</a>
</th>
<td> -
</td></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Debuggers</a>
</th>
<td> <a href="./User:Iarganda" title="User:Iarganda">Ignacio Arganda-Carreras</a>
</td></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Reviewers</a>
</th>
<td> <a href="./User:Iarganda" title="User:Iarganda">Ignacio Arganda-Carreras</a>
</td></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Support</a>
</th>
<td> <a href="./User:Iarganda" title="User:Iarganda">Ignacio Arganda-Carreras</a>
</td></tr>
<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Maintainers</a>
</th>
<td> <a href="./User:Iarganda" title="User:Iarganda">Ignacio Arganda-Carreras</a>, <a href="./User:Rueden" title="User:Rueden">Curtis Rueden</a>
</td></tr>

<tr>
<th> <a href="Team" class="mw-redirect" title="Team">Contributors</a>
</th>
<td> <a rel="nofollow" class="external text" href="https://github.com/jkybic">Jan Kybic</a>, <a href="./User:Albertcardona" title="User:Albertcardona">Albert Cardona</a>, <a href="./User:Schindelin" title="User:Schindelin">Johannes Schindelin</a>, <a href="./User:Hinerm" title="User:Hinerm">Mark Hiner</a>
</td></tr>
</table><div class="project-info">
<span class="project-logo"><a href="Fiji" title="Fiji"><img class="simple-tooltip simple-tooltip-img" data-simple-tooltip="This page describes content which is part of the Fiji distribution of ImageJ. Click the logo for details." src="_images/a/ae/Fiji-icon.png"></img></a></span></div>
<table>
<tr>
<td style="vertical-align:top"><a href="./File:BUnwarpJ_scheme.png" class="image" title="bUnwarpJ scheme: bidirectional Unwarping in Java."><img alt="bUnwarpJ scheme: bidirectional Unwarping in Java." src="_images/1/18/BUnwarpJ_scheme.png" width="390" height="292" /></a>
</td></tr></table>
<p>This ImageJ/Fiji plugin performs <b>2D image registration based on elastic deformations</b> represented by B-splines. The invertibility of the deformations is enforced through a consistency restriction. 
</p><p>For a quick start, you can have a look at the <a rel="nofollow" class="external text" href="http://imagejdocu.tudor.lu/doku.php?id=video:aligning:bunwarpj_basic_tutorial">video tutorial</a> (awarded at the Second ImageJ User &amp; Developer Conference).
</p><p><br />
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="BUnwarpJ.html#General_Description"><span class="tocnumber">1</span> <span class="toctext">General Description</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="BUnwarpJ.html#Technical_Explanations"><span class="tocnumber">2</span> <span class="toctext">Technical Explanations</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="BUnwarpJ.html#User_Manual"><span class="tocnumber">3</span> <span class="toctext">User Manual</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="BUnwarpJ.html#Generalities"><span class="tocnumber">3.1</span> <span class="toctext">Generalities</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="BUnwarpJ.html#Landmarks"><span class="tocnumber">3.1.1</span> <span class="toctext">Landmarks</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="BUnwarpJ.html#Masks"><span class="tocnumber">3.1.2</span> <span class="toctext">Masks</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="BUnwarpJ.html#Input.2FOutput_options"><span class="tocnumber">3.1.3</span> <span class="toctext">Input/Output options</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-8"><a href="BUnwarpJ.html#Macro_call"><span class="tocnumber">3.2</span> <span class="toctext">Macro call</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="BUnwarpJ.html#Main_dialog"><span class="tocnumber">3.2.1</span> <span class="toctext">Main dialog</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="BUnwarpJ.html#I.2FO_methods"><span class="tocnumber">3.2.2</span> <span class="toctext">I/O methods</span></a>
<ul>
<li class="toclevel-4 tocsection-11"><a href="BUnwarpJ.html#Old_methods"><span class="tocnumber">3.2.2.1</span> <span class="toctext">Old methods</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-12"><a href="BUnwarpJ.html#Command_line_call"><span class="tocnumber">3.3</span> <span class="toctext">Command line call</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="BUnwarpJ.html#Consistency_weight"><span class="tocnumber">3.4</span> <span class="toctext">Consistency weight</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="BUnwarpJ.html#SIFT_and_MOPS_plugin_support"><span class="tocnumber">3.5</span> <span class="toctext">SIFT and MOPS plugin support</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15"><a href="BUnwarpJ.html#Downloads"><span class="tocnumber">4</span> <span class="toctext">Downloads</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="BUnwarpJ.html#API_documentation"><span class="tocnumber">4.1</span> <span class="toctext">API documentation</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="BUnwarpJ.html#Installation"><span class="tocnumber">4.2</span> <span class="toctext">Installation</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-18"><a href="BUnwarpJ.html#Frequently_Asked_Questions"><span class="tocnumber">5</span> <span class="toctext">Frequently Asked Questions</span></a>
<ul>
<li class="toclevel-2 tocsection-19"><a href="BUnwarpJ.html#How_do_I_choose_the_weights.3F_What_does_each_of_the_weights_really_mean.3F"><span class="tocnumber">5.1</span> <span class="toctext">How do I choose the weights? What does each of the weights really mean?</span></a>
<ul>
<li class="toclevel-3 tocsection-20"><a href="BUnwarpJ.html#Divergence_and_curl_weights"><span class="tocnumber">5.1.1</span> <span class="toctext">Divergence and curl weights</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="BUnwarpJ.html#Landmark_weight"><span class="tocnumber">5.1.2</span> <span class="toctext">Landmark weight</span></a></li>
<li class="toclevel-3 tocsection-22"><a href="BUnwarpJ.html#Image_weight"><span class="tocnumber">5.1.3</span> <span class="toctext">Image weight</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="BUnwarpJ.html#Consistency_weight_2"><span class="tocnumber">5.1.4</span> <span class="toctext">Consistency weight</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-24"><a href="BUnwarpJ.html#How_do_I_choose_the_initial_and_final_deformations.3F_What_do_they_mean.3F"><span class="tocnumber">5.2</span> <span class="toctext">How do I choose the initial and final deformations? What do they mean?</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="BUnwarpJ.html#Can_bUnwarpJ_register_3D_images.3F"><span class="tocnumber">5.3</span> <span class="toctext">Can bUnwarpJ register 3D images?</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="BUnwarpJ.html#How_do_I_cite_bUnwarpJ.3F"><span class="tocnumber">5.4</span> <span class="toctext">How do I cite bUnwarpJ?</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="BUnwarpJ.html#Can_I_run_bUnwarpJ_without_the_graphical_interface.3F"><span class="tocnumber">5.5</span> <span class="toctext">Can I run bUnwarpJ without the graphical interface?</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="BUnwarpJ.html#My_result_images_are_32-bit_although_my_input_images_are_8-bit.2C_is_that_a_bug.3F"><span class="tocnumber">5.6</span> <span class="toctext">My result images are 32-bit although my input images are 8-bit, is that a bug?</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="BUnwarpJ.html#How_do_I_integrate_the_SIFT.2FMOPS_results_into_bUnwarpJ.3F"><span class="tocnumber">5.7</span> <span class="toctext">How do I integrate the SIFT/MOPS results into bUnwarpJ?</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="BUnwarpJ.html#What_does_.22source_and_target.22_mean.3F_Which_image_is_being_transformed.3F"><span class="tocnumber">5.8</span> <span class="toctext">What does "source and target" mean? Which image is being transformed?</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="BUnwarpJ.html#What_is_the_format_of_the_raw_transformation_file.3F"><span class="tocnumber">5.9</span> <span class="toctext">What is the format of the raw transformation file?</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-32"><a href="BUnwarpJ.html#References_.28Citation.29"><span class="tocnumber">6</span> <span class="toctext">References (Citation)</span></a></li>
<li class="toclevel-1 tocsection-33"><a href="BUnwarpJ.html#License"><span class="tocnumber">7</span> <span class="toctext">License</span></a></li>
<li class="toclevel-1 tocsection-34"><a href="BUnwarpJ.html#Acknowledgements"><span class="tocnumber">8</span> <span class="toctext">Acknowledgements</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="General_Description">General Description</span></h2>
<p><strong class="selflink">bUnwarpJ</strong> is an algorithm for <b>elastic and consistent image registration</b> developed as an ImageJ plugin. It performs a simultaneous registration of two images, A and B. Image A is elastically deformed in order to look as similar as possible to image B, and, at the same time, the "inverse" transformation (from B to A) is also calculated so a pseudo-invertibility of the final deformation could be guaranteed. Two images are given as a result: the deformed versions of A and B images.
</p>
<h2><span class="mw-headline" id="Technical_Explanations">Technical Explanations</span></h2>
<p>This image registration algorithm is based on the minimization of an energy functional that includes the dissimilarity between the source and target images -in both directions- <img class="mwe-math-fallback-image-inline tex" alt="E_{img}" src="_images/math/6/7/6/6762f3f13193b074ef085f0a5c881900.png" />, an optional landmark constraint <img class="mwe-math-fallback-image-inline tex" alt="E_{\mu}" src="_images/math/f/b/1/fb13fad70bbb1e097f7e4e70ee50065c.png" />, a regularization term <img class="mwe-math-fallback-image-inline tex" alt="(E_{div} + E_{rot})" src="_images/math/b/d/6/bd6442df91be83abb7fca37ac7582b3b.png" />, and an energy term <img class="mwe-math-fallback-image-inline tex" alt="E_{cons}" src="_images/math/6/1/3/613dcf6f9138fb5e8aa618d1973b542a.png" /> that accounts for the geometrical consistency between the elastic deformation in both directions. Namely, the energy function is given by
</p>
<dl><dd><dl><dd><dl><dd><dl><dd><dl><dd><img class="mwe-math-fallback-image-inline tex" alt=" E = w_iE_{img} + w_{\mu}E_{\mu} + (w_dE_{div} + w_rE_{rot}) + w_cE_{cons} " src="_images/math/4/3/1/431358e903cc2d9a337e9a5ac0925c05.png" /></dd></dl></dd></dl></dd></dl></dd></dl></dd></dl>
<p>Where the weights of every term are set by the user in the main window of the plugin. The optimization process is a <a rel="nofollow" class="external text" href="https://en.wikipedia.org/wiki/Levenberg%E2%80%93Marquardt_algorithm">Levenberg-Marquardt</a> minimization enhanced by a <a rel="nofollow" class="external text" href="https://en.wikipedia.org/wiki/Broyden%E2%80%93Fletcher%E2%80%93Goldfarb%E2%80%93Shanno_algorithm">Broyden-Fletcher-Goldfarb-Shanno (BFGS)</a> estimate of the local Hessian of the goal function, and both, images and deformations are represented by <a rel="nofollow" class="external text" href="https://en.wikipedia.org/wiki/B-spline">cubic B-splines</a>.
</p>
<h2><span class="mw-headline" id="User_Manual">User Manual</span></h2>
<h3><span class="mw-headline" id="Generalities">Generalities</span></h3>
<p>The plugin can be called from the main ImageJ/Fiji menu under Plugins &gt; Registration &gt; bUnwarpJ. Two images (<b>8, 16, 32-bit grayscale or RGB Color</b>) need to be opened in order to be able to use the plugin. If so, the maing dialog window of the plugin will open.
</p>
<div class="thumb tright"><div class="thumbinner" style="width:302px;"><a href="./File:BUnwarpJ-main-dialog.png" class="image"><img alt="" src="_images/a/a9/BUnwarpJ-main-dialog.png" width="300" height="455" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-main-dialog.png" class="internal" title="Enlarge"></a></div>bUnwarpJ main dialog</div></div></div>
<p><b>Both selected images will work simultaneously as source and target</b>, their tags are there only for the sake of clarification. The registration mode can be "Accurate", "Fast" and "Mono". The registration mode "<b>Mono</b>" (included since version 2.5) makes the program to perform only <b>unidirectional</b> registration, i.e. from source to target. The two registration modes "Accurate" and "Fast" involve performing <b>bidirectional</b> registration and affect the stopping criteria internally used by the program.  More internal options can be modified in the "Advanced Options" panel. This panel gives you access to most of the internal parameters of the algorithm. The "Initial" and "Final" deformation lists allow you to select the coarsest and finest scale of the spline deformation field. "Very coarse" corresponds to 4 splines (one in each corner of the image). As you increase the deformation level, the number of splines is doubled in each direction (horizontal and vertical).
</p><p>Since <b>bUnwarpJ 2.5</b> there is a new parameter on the main window to allow <b>subsampling</b> the input images. The registration will be then calculated using the subsampled versions of the images but the results will be applied to the original ones. The image subsampling parameter can be chosen between <b>0 and 7</b>, i.e. the image dimensions can be reduced by a factor of 2<sup>0</sup> = 1 to 2<sup>7</sup> = 128. This is very useful when registering large images.
</p><p>The different weights of the goal function control the relative weight of each one of the terms. These weights are not restricted to be between 0 and 1, and they may take any value as long as it is non-negative. You can see a <b>description of the different function weights</b> in the presentation "<a rel="nofollow" class="external text" href="https://sites.google.com/site/iargandacarreras/bUnwarpJ_ImageJ_Conf_2008_presentation.pdf">bUnwarpJ: Consistent and Elastic Registration in ImageJ. Methods and Applications</a>.", given at the Second ImageJ User &amp; Developer Conference (2008) or have a look at the FAQ section.
</p><p>The stop threshold is used by the algorithm to stop the optimization process at each multiresolution level when the error relative change is not larger than this threshold.
</p><p><b>RGB Color images will be converted to grayscale during the registration process</b> but the resulting transformations will be applied to the original color images.
</p><p>If you want to exit the plugin, press "Cancel". When you want the plugin to perform the registration press "OK". After running the plugin (on "Accurate" or "Fast" mode), <b>the results are two stacks</b> with the following three images:
</p>
<ol><li> One image (warping image) registered as to fit the other image (fixed image);</li>
<li> The fixed image;</li>
<li> The warping mask with the same deformation as the warping image. </li></ol>
<p>The final registration values appear in a separate ("Results") window.
</p><p>The following figure shows one of the <b>resulting stacks</b> from registering a source (moving) Lena image to a target (fixed) warped version of the same image:
</p>
<div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:762px;"><a href="./File:BUnwarpJ-lena-basic-result.png" class="image"><img alt="" src="_images/0/0c/BUnwarpJ-lena-basic-result.png" width="760" height="307" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-lena-basic-result.png" class="internal" title="Enlarge"></a></div>From left to right, consecutive slices of the resulting stack: elastic-transformed image, original moving image and warped moving mask.</div></div></div></div>
<p><br />
The <b>verbose mode</b> produces more information:
</p>
<ol><li> The elastic deformation as a vector field. Each point in the fixed image must be deformed according to this field to fit into the warping image;</li>
<li> The grid obtained after deforming the fixed image with the vector field described above;</li>
<li> The step values of the optimization process in a separate ("Results") window.</li></ol>
<div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:762px;"><a href="./File:BUnwarpJ-lena-verbose-result.png" class="image"><img alt="" src="_images/3/30/BUnwarpJ-lena-verbose-result.png" width="760" height="258" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-lena-verbose-result.png" class="internal" title="Enlarge"></a></div>From left to right: the last consecutive slices of the resulting stack in verbose mode (deformation field and deformation grid) and the Log window with the optimization steps, final optimal values and execution time.</div></div></div></div>
<p>Since both, source and target images work as moving and fixed images, <b>there are two sets (stacks) of results</b>: from source to target and from target to source.
</p><p>The "Mono" mode produces only results from the source to the target image.
</p><p>During the registration process, the current difference images and a mapping of the grid from the fixed images onto the moving images are shown:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:462px;"><a href="./File:BUnwarpJ-lena-during-registration.png" class="image"><img alt="" src="_images/4/4a/BUnwarpJ-lena-during-registration.png" width="460" height="260" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-lena-during-registration.png" class="internal" title="Enlarge"></a></div>Example of bUnwarpJ output during the registration process: difference image and grid on top of moving image.</div></div></div></div>
</td></tr></table>
<p>During the registration process the toolbar will be changed to
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-when-registering.png" class="image"><img alt="" src="_images/f/f8/BUnwarpJ-toolbar-when-registering.png" width="500" height="84" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-when-registering.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar when the registration process has started.</div></div></div></div>
</td></tr></table>
<p>Click on the stop button to stop the process. The output at the current state of the optimization will be returned in the normal way.
</p>
<h4><span class="mw-headline" id="Landmarks">Landmarks</span></h4>
<p>When the plugin is called and before pressing "OK" in the main window, the toolbar changes its appearance and it is possible to manually add landmarks to the selected images:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-add-crosses.png" class="image"><img alt="" src="_images/c/c4/BUnwarpJ-toolbar-add-crosses.png" width="500" height="84" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-add-crosses.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar before starting registration.</div></div></div></div>
</td></tr></table>
<p>The depressed button indicates that you may <b>add a landmark</b> now. Landmarks are added in either image. The landmark will be automatically placed in the same position on both images. The new landmark becomes the "current landmark" (indicated by a thicker [+] sign in the current image and a [×] sign in the other image, while all the rest are represented by [+] signs). To move any landmark, press on the "<b>Move crosses</b>" button:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-move-crosses.png" class="image"><img alt="" src="_images/2/27/BUnwarpJ-toolbar-move-crosses.png" width="500" height="84" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-move-crosses.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar with "Move crosses" button selected.</div></div></div></div>
</td></tr></table>
<p>Click and drag on any landmark to make it correspond to the same position in both images. Here goes an example of the two Lena images with corresponding landmarks:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:542px;"><a href="./File:BUnwarpJ-landmarks-example.png" class="image"><img alt="" src="_images/2/29/BUnwarpJ-landmarks-example.png" width="540" height="303" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-landmarks-example.png" class="internal" title="Enlarge"></a></div>Example of landmarks on moving and fixed images.</div></div></div></div>
</td></tr></table>
<p>Landmarks can be removed through the "<b>Remove crosses</b>" button:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-remove-crosses.png" class="image"><img alt="" src="_images/1/13/BUnwarpJ-toolbar-remove-crosses.png" width="500" height="84" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-remove-crosses.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar with "Remove crosses" button selected so the user can remove landmarks.</div></div></div></div>
</td></tr></table>
<p>This is the way of manually adding landmarks to the registration process. However, <b>since bUnwarpJ v2.0</b> there is the option as well of using automatic landmarks as explained in the section SIFT and MOPS support, <b>or manually adding point selections in both images before calling the plugin</b>. If the number of point selections is the same in both images, they will be transformed into landmarks.
</p><p><b>When exiting bUnwarpJ all the images are restored to their previous state</b>, i.e. the original regions of interest and point selections are restored.
</p>
<h4><span class="mw-headline" id="Masks">Masks</span></h4>
<p>This program allows you using masks in <b>two mutually exclusive ways</b>. In the first way, masks are introduced together with the input images. In this mode, input images must be a stack of images (first slice: the image itself, second slice: the mask). In this way, the mask can have any shape. In the second way, the input images must not be stacks and simple polygonal masks can be used. These masks are defined using the two buttons ("<b>Draw an inner mask</b>" and "<b>Draw an outer mask</b>") shown below:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-draw-inner-mask.png" class="image"><img alt="" src="_images/1/1d/BUnwarpJ-toolbar-draw-inner-mask.png" width="500" height="84" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-draw-inner-mask.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar with "Draw an inner mask" button selected.</div></div></div></div>
</td></tr>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-draw-outer-mask.png" class="image"><img alt="" src="_images/e/e8/BUnwarpJ-toolbar-draw-outer-mask.png" width="500" height="84" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-draw-outer-mask.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar with "Draw an outer mask" button selected.</div></div></div></div>
</td></tr></table>
<p>The inner mask keeps the information in the interior of the polygon, while the outer mask keeps the information in the exterior of the polygon. The thrown-out information is grayed. Here goes an example of an inner mask:
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:262px;"><a href="./File:BUnwarpJ-inner-mask-example.png" class="image"><img alt="" src="_images/a/a1/BUnwarpJ-inner-mask-example.png" width="260" height="294" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-inner-mask-example.png" class="internal" title="Enlarge"></a></div>bUnwarpJ example of inner mask on Lena image.</div></div></div></div>
</td></tr></table>
<p>Masks can be used for one of the images, both, or none. You can put a mask in one of the images and not in the other, you can put a mask (with different shapes) in both images, or you may not use masks at all. After calling the plugin, the masks are erased and the initial images are restored.
</p>
<h4><span class="mw-headline" id="Input.2FOutput_options">Input/Output options</span></h4>
<p>When using the "<b>Input/Output Menu</b>" from the toolbar, we have the possibility of processing different input and output files that will affect the registration.
</p>
<table>
<tr>
<td><div class="center"><div class="thumb tnone"><div class="thumbinner" style="width:502px;"><a href="./File:BUnwarpJ-toolbar-IO-menu.png" class="image"><img alt="" src="_images/c/c2/BUnwarpJ-toolbar-IO-menu.png" width="500" height="88" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-toolbar-IO-menu.png" class="internal" title="Enlarge"></a></div>bUnwarpJ toolbar with "Input/Output menu" button selected.</div></div></div></div>
</td></tr></table>
<div class="thumb tright"><div class="thumbinner" style="width:302px;"><a href="./File:BUnwarpJ-IO-menu.png" class="image"><img alt="" src="_images/b/b1/BUnwarpJ-IO-menu.png" width="300" height="479" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-IO-menu.png" class="internal" title="Enlarge"></a></div>bUnwarpJ Input/Output menu.</div></div></div>
<p><br />
In the last release, the plugin presents the following Input/Output options:
</p>
<ul><li> <b>Load Landmarks</b>: it allows loading landmarks files.</li>
<li> <b>Save Landmarks As</b>: it allows saving the image landmarks into a file.</li>
<li> <b>Show Landmarks</b>: it forces the landmarks to be displayed in a separate table.</li>
<li> <b>Load Elastic Transformation</b>: it loads an elastic transformation from a file and applies it to the so-called source image. The transformation file must be in the format of the plugin B-spline transformations, i.e. the same format as the files created with the "Save Transformation" option.</li>
<li> <b>Load Raw Transformation</b>: it loads a raw transformation from a file and applies it to the so-called source image. The transformation file must be in "raw" format, i.e. the same format as the files created with the "Convert Transformation To Raw" option. See the <a href="BUnwarpJ#What_is_the_format_of_the_raw_transformation_file.3F" title="BUnwarpJ"> raw transformation example</a> for a format description.</li>
<li> <b>Compare Opposite Elastic Transformations</b>: it calculates the warping index of two elastic transformations, i.e. the average of the geometrical distance between every pixel and its version after applying both transformations (direct and inverse). This value is given as a result. The transformation files must be in the format of the plugin B-spline transformations (same format as the files created with the "Save Transformation" option).</li>
<li> <b>Compare Elastic/Raw Transformations</b>: it calculates the warping index of an elastic and a raw transformation (same direction). The second transformation file must be in "raw" format, i.e. the same format as the files created with the "Convert Transformation To Raw" option.</li>
<li> <b>Compare Raw Transformations</b>: it calculates the warping index of two raw transformations (same direction). The transformation file must be in "raw" format, i.e. the same format as the files created with the "Convert Transformation To Raw" option.</li>
<li> <b>Convert Transformation To Raw</b>: it converts a B-spline transformation file into a raw transformation file.</li>
<li> <b>Convert Transformation To Elastic</b>: it converts a raw transformation file into a B-spline transformation file (approximation).</li>
<li> <b>Compose Elastic Transformations</b>: it composes two elastic transformations into a raw transformation. The input files must be in the B-spline transformation format, and the output file will be in "raw" format.</li>
<li> <b>Compose Raw Transformations</b>: it composes two raw transformations into another raw transformation. Both input and output files will be in "raw" format.</li>
<li> <b>Compose Raw and Elastic Transformations</b>: it composes one raw transformation and one elastic transformation into a raw transformation.</li>
<li> <b>Invert Raw Transformation</b>: it approximates the inverse of a raw transformation.</li>
<li> <b>Evaluate Image Similarity</b>: it calculates de current similarity error between the source and target images. The results is displayed in the "Results" window.</li>
<li> <b>Adapt Coefficients</b>: it transforms the coefficients of an specific elastic transformation according to a real image factor. Very useful for example when we have very large images. We can register subsampled versions of our images (let us say 4 times smaller) and then adapt the result transformations (image factor = 4) so we can apply them to the high resolution images.</li>
<li> <b>Load Source Mask</b>: it loads a mask from file (binary image) in the source image.</li>
<li> <b>Load Source Initial Affine Matrix</b>: it loads an affine matrix as starting point for the source-target transformation from a text file. The format of the text files is as follows: <code>cos(angle) -sin(angle) sin(angle) cos(angle) Translation_X Translation_Y</code></li></ul>
<p>These new options (since version 1.1) allow the user comparing the results of our program with any other registration method. 
</p><p>You can also test bUnwarpJ with <a href="Spline_Deformation_Generator" title="Spline Deformation Generator">Spline Deformation Generator</a>, an ImageJ plugin that allows the user to generate five different image deformations: elastic, fisheye, perspective, barrel/pincushion and smile effect. <a href="Spline_Deformation_Generator" title="Spline Deformation Generator">Spline Deformation Generator</a> uses the same raw transformation file format as bUnwarpJ, so they are completely compatible.
</p>
<h3><span class="mw-headline" id="Macro_call">Macro call</span></h3>
<p><strong class="selflink">bUnwarpJ</strong> is completely compatible with the <a rel="nofollow" class="external text" href="http://rsb.info.nih.gov/ij/developer/macro/macros.html">ImageJ macro language</a>. When in doubt, use the <a href="Introduction_into_Macro_Programming#The_recorder" title="Introduction into Macro Programming">Macro Recorder</a> to identify which commands need to be used.
</p>
<h4><span class="mw-headline" id="Main_dialog">Main dialog</span></h4>
<p>The user can launch the plugin from a macro by setting all the parameters of the plugin main dialog, for instance:
</p>
<pre class="brush:java">
run( "bUnwarpJ", "source_image=A target_image=B registration=Accurate 
      image_subsample_factor=0 initial_deformation=[Very Coarse] 
      final_deformation=Fine divergence_weight=0 curl_weight=0 landmark_weight=0 
      image_weight=1 consistency_weight=10 stop_threshold=0.01
      save_transformations
      save_direct_transformation=/my-path/A_direct_transf.txt 
      save_inverse_transformation=/my-path/B_inverse_transf.txt");
</pre>
<p>Notice the path to the transformation files are only needed if the "save_transformations" option is used.
</p>
<h4><span class="mw-headline" id="I.2FO_methods">I/O methods</span></h4>
<p>To use the main Input/Output options from a macro, there is a corresponding static method defined in the main class (bUnwarpJ_). Again, the <a href="Introduction_into_Macro_Programming#The_recorder" title="Introduction into Macro Programming">Macro Recorder</a> will provide with the right macro command for each of them. For example:
</p>
<ul><li> Load elastic transformation to source image:</li></ul>
<pre class="brush:java">
call("bunwarpj.bUnwarpJ_.loadElasticTransform", "/my-path-to-transf/source_elastic_transf.txt", "target-image.png", "source-image.png");
</pre>
<ul><li> Load raw transformation to source image:</li></ul>
<pre class="brush:java">
call("bunwarpj.bUnwarpJ_.loadRawTransform", "/my-path-to-transf/source_raw_transf.txt", "target-image.png", "source-image.png");
</pre>
<ul><li> Compare opposite elastic transforms:</li></ul>
<pre class="brush:java">
call("bunwarpj.bUnwarpJ_.compareOppositeElasticTransforms", "/my-path-to-transf/inverse_transf.txt", "/my-path-to-transf/direct_transf.txt", "target-image.png", "source-image.png");
</pre>
<ul><li> Compare elastic and raw transforms (same direction):</li></ul>
<pre class="brush:java">
call("bunwarpj.bUnwarpJ_.compareElasticRawTransforms", "/my-path/source_direct_transf.txt", "/my-path/source_direct_transf_RAW.txt", "target-image.png", "source-image.png");
</pre>
<ul><li> ... and so on.</li></ul>
<h5><span class="mw-headline" id="Old_methods">Old methods</span></h5>
<p>Before bUnwarpJ v2.6.7, these calls were done using methods that work on image files (not open in ImageJ). For backward compatibility reasons, these methods are still usable:
<a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#elasticTransformImageMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">elasticTransformImageMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#rawTransformImageMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">rawTransformImageMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#composeRawElasticTransformationsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">composeRawElasticTransformationsMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#composeRawTransformationsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">composeRawTransformationsMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#composeElasticTransformationsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">composeElasticTransformationsMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#compareElasticRawTransformationsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">compareElasticRawTransformationsMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#compareElasticTransformationsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">compareElasticTransformationsMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#compareRawTransformationsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">compareRawTransformationsMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#convertToRawTransformationMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">convertToRawTransformationMacro</a>, <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#adaptCoefficientsMacro(java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String,%20java.lang.String)">adaptCoefficientsMacro</a>.
</p><p>Notice here that the input and output file names must include the path, since they are not taken from the list of images. For instance, if we want to apply an elastic deformation stored in the file <i>A_direct_transf.txt</i> to the source image <i>A.jpg</i> with target image <i>B.jpg</i> and save the result in <i>output.tif</i>, we call:
</p>
<pre class="brush:java">
call( "bunwarpj.bUnwarpJ_.elasticTransformImageMacro", "My_path/A.jpg",
      "My_path/B.jpg", "My_path/A_direct_transf.txt", "My_path/output.tif" );
</pre>
<h3><span class="mw-headline" id="Command_line_call">Command line call</span></h3>
<p><strong class="selflink">bUnwarpJ</strong> might be called as well as an ImageJ command from the command line. In the command line, the program offers the following options:
</p>
<ul><li><code>-help</code>: shows the syntax of the program</li>
<li><code>-align</code>: launches the registration of two input images</li>
<li><code>-elastic_transform</code>: transforms the source image with a given elastic deformation (previously calculated)</li>
<li><code>-raw_transform</code>: transforms the source image with a given raw deformation (previously calculated)</li>
<li><code>-compare_elastic</code>: compares two previously calculated opposite elastic deformations through the warping index</li>
<li><code>-compare_elastic_raw</code>: compares an elastic deformation with a raw deformation (both direct transformations) through the warping index</li>
<li><code>-compare_raw</code>: compares two previously calculated and direct raw deformations through the warping index</li>
<li><code>-convert_to_raw</code>: converts an elastic transformation into raw format</li>
<li><code>-compose_elastic</code>: composes two elastic deformations, the result will be in raw format</li>
<li><code>-compose_raw</code>: composes two raw deformations, the result will be too in raw format</li>
<li><code>-compose_raw_elastic</code>: composes a raw deformation and an elastic one. Result in raw format</li>
<li><code>-adapt_transform</code>: adapts an specific elastic transformation given a resolution image factor</li></ul>
<p>For instance, to see the program help we can call the program from the command line (where $IJDIR is the directory where ImageJ is installed) like this in Linux:
</p><p><code>java -Xmx512m -cp $IJDIR/ij.jar:$IJDIR/plugins/bUnwarpJ_.jar bunwarpj.bUnwarpJ_ -help</code>
</p><p><br />
For the rest of the options, follow the help instructions.
</p>
<h3><span class="mw-headline" id="Consistency_weight">Consistency weight</span></h3>
<p>The main reason to create <strong class="selflink">bUnwarpJ</strong> was the idea of enforcing deformations' consistency through the consistency weight. This number forces the algorithm to move into solutions that ensure the invertibility of the resulting deformations. Therefore, the higher this number is, the more strictly one deformation is the inverse of the other one. Due to the different units, there is no rule for selecting the right parameters, they need to be found experimentally.
</p><p>One important advantage of <strong class="selflink">bUnwarpJ</strong> over the previous method lies in the fact that many registration problems can be solved without using the landmarks and regularization terms of the energy function (that means setting their corresponding parameters to 0.0). Therefore, no user interaction is needed and the computational complexity of the algorithm is reduced.
</p>
<h3><span class="mw-headline" id="SIFT_and_MOPS_plugin_support">SIFT and MOPS plugin support</span></h3>
<div class="thumb tright"><div class="thumbinner" style="width:302px;"><a href="./File:BUnwarpJ-lena-SIFT-landmarks-example.png" class="image"><img alt="" src="_images/0/07/BUnwarpJ-lena-SIFT-landmarks-example.png" width="300" height="340" class="thumbimage" /></a>  <div class="thumbcaption"><div class="magnify"><a href="./File:BUnwarpJ-lena-SIFT-landmarks-example.png" class="internal" title="Enlarge"></a></div>bUnwarpJ: example of SIFT correspondences converted to registration landmarks.</div></div></div>The last release of bUnwarpJ has compatibility with Stephan Saalfeld's plugin for automatic <a href="Feature_Extraction" title="Feature Extraction"> feature extraction</a> (implementations of SIFT and MOPS algorithms).
<p>An explanation of the parameters is <a href="Feature_Extraction#Parameters" title="Feature Extraction"> here</a>. This plugin is also integrated in Fiji.
</p><p>After applying SIFT or MOPS methods, you will get two sets of corresponding points in both images. If you call then <strong class="selflink">bUnwarpJ</strong>, the corresponding points will appear as source and target landmarks.
</p>
<h2><span class="mw-headline" id="Downloads">Downloads</span></h2>
<p>The latest stable distribution of bUnwarpJ can always be found included within Fiji and the <b>latest released JARs are available in the</b> <a rel="nofollow" class="external text" href="https://github.com/fiji/bUnwarpJ/releases">GitHub repository</a>. If you detect any bug, please feel free to contact the maintainer. Any feedback will be very appreciated.
</p>
<h3><span class="mw-headline" id="API_documentation">API documentation</span></h3>
<p>The API documentation can be reached <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/package-summary.html">online</a>.
</p>
<h3><span class="mw-headline" id="Installation">Installation</span></h3>
<p>In Fiji, <strong class="selflink">bUnwarpJ</strong> comes installed by default. In ImageJ, you must simply download the latest bUnwarpJ_.jar to the Plugins folder of ImageJ, restart ImageJ and there will be a new "Registration &gt; bUnwarpJ" command in the Plugins menu.
</p><p>To execute bUnwarpJ as a macro or from the command line, see the description in the User Manual.
</p>
<h2><span class="mw-headline" id="Frequently_Asked_Questions">Frequently Asked Questions</span></h2>
<h3><span class="mw-headline" id="How_do_I_choose_the_weights.3F_What_does_each_of_the_weights_really_mean.3F">How do I choose the weights? What does each of the weights really mean?</span></h3>
<p>The weights need to be chosen experimentally, test and error is the only way of knowing which are the best weights to register your images, but let 's talk about them in detail:
</p>
<h4><span class="mw-headline" id="Divergence_and_curl_weights">Divergence and curl weights</span></h4>
<p>The divergence and curl weights regularize the deformation by penalizing the <a rel="nofollow" class="external text" href="https://en.wikipedia.org/wiki/Divergence">divergence</a> and <a rel="nofollow" class="external text" href="https://en.wikipedia.org/wiki/Curl_%28mathematics%29">curl</a> of the deformation vector field. In other words, we penalize vector fields with <b>many</b> points like this:
</p>
<div class="MediaTransformError" style="width: 430px; height: 0px; display:inline-block;">Error creating thumbnail: Unable to save thumbnail to destination</div>
<p>These are attractor points that make the deformation too rough. One of them would not be a problem (it could be just a rotation), but many yes. So controlling them we make the deformation <b>smooth</b>. If you see that your transformations get too rough, it is a good idea to use them. <b>0.1 and 0.1 are usually good values</b>  if there's no prior knowledge about the deformation shape.
</p>
<h4><span class="mw-headline" id="Landmark_weight">Landmark weight</span></h4>
<p>It forces the deformations to fit the landmark points on both images. Set it to <b>1.0</b> unless you're not using landmarks.
</p>
<h4><span class="mw-headline" id="Image_weight">Image weight</span></h4>
<p>This is the weight to control the pixel values differences. Leave it to <b>1.0</b> unless you want to do for instance landmark-only registration.
</p>
<h4><span class="mw-headline" id="Consistency_weight_2">Consistency weight</span></h4>
<p>It forces the resulting deformations to be one (source to target) as close as possible to the inverse of the other one (target to source). Values <b>between 10.0 and 30.0</b> usually work fine. It is only taken into account for registration modes "Fast" or "Accurate".
</p>
<h3><span class="mw-headline" id="How_do_I_choose_the_initial_and_final_deformations.3F_What_do_they_mean.3F">How do I choose the initial and final deformations? What do they mean?</span></h3>
<p>These values determine the level of detail of the initial and final deformations. In <strong class="selflink">bUnwarpJ</strong> this is defined by the number of B-splines that we use to represent the deformations:
</p>
<table class="wikitable" style="text-align:center;">
<tr>
<th>Deformation
</th>
<th>Number of intervals (in the B-spline grid)
</th></tr>
<tr>
<td>Very coarse
</td>
<td>1x1
</td></tr>
<tr>
<td>Coarse
</td>
<td>2x2
</td></tr>
<tr>
<td>Fine
</td>
<td>4x4
</td></tr>
<tr>
<td>Very Fine
</td>
<td>8x8
</td></tr>
<tr>
<td>Super fine
</td>
<td>16x16
</td></tr></table>
<p>How to choose the initial and final deformation? It depends on how misaligned your images are. If they start very far away from the right alignment, it is usually a good idea to go from "Very Coarse" to "Very Fine". If they start close to the right alignment, using a very coarse initial deformation could cause the algorithm to fail. So, in that case, it would be enough to set initial deformation to "Fine" and final deformation to "Very Fine". Use "Super Fine" only when you need a very high level of accuracy, because it makes the algorithm quite slower depending on the image sizes.
</p>
<h3><span class="mw-headline" id="Can_bUnwarpJ_register_3D_images.3F">Can bUnwarpJ register 3D images?</span></h3>
<p>Unfortunately, <b>no</b>. If you call <strong class="selflink">bUnwarpJ</strong> with two stacks as input images, it will use the second slice of every stack as the corresponding mask of the first slice. If you're looking for 3D image registration software, you may want to have a look at <a rel="nofollow" class="external text" href="http://elastix.isi.uu.nl/">Elastix</a>, an excellent open source toolkit to perform image registration written in <a rel="nofollow" class="external text" href="http://www.itk.org/">ITK</a>.
</p>
<h3><span class="mw-headline" id="How_do_I_cite_bUnwarpJ.3F">How do I cite bUnwarpJ?</span></h3>
<p>The corresponding paper citation is on the <a href="BUnwarpJ#References" title="BUnwarpJ">References</a>.
</p>
<h3><span class="mw-headline" id="Can_I_run_bUnwarpJ_without_the_graphical_interface.3F">Can I run bUnwarpJ without the graphical interface?</span></h3>
<p><b>Yes</b>, you can. You have different possibilities: 
</p>
<ul><li> You could call the program from the command line as explained in the <a href="BUnwarpJ#User_Manual" title="BUnwarpJ">user manual</a>,</li>
<li> or you can make a <a href="BUnwarpJ#Macro_call" title="BUnwarpJ">macro call</a> in batch mode,</li>
<li> or you could as well create a script and use any of the methods called <a rel="nofollow" class="external text" href="http://javadoc.imagej.net/Fiji/bunwarpj/bUnwarpJ_.html#alignImagesBatch(ij.ImagePlus,%20ij.ImagePlus,%20ij.process.ImageProcessor,%20ij.process.ImageProcessor,%20int,%20int,%20int,%20int,%20double,%20double,%20double,%20double,%20double,%20double)">bUnwarpJ_.alignImagesBatch</a>.</li></ul>
<h3><span class="mw-headline" id="My_result_images_are_32-bit_although_my_input_images_are_8-bit.2C_is_that_a_bug.3F">My result images are 32-bit although my input images are 8-bit, is that a bug?</span></h3>
<p>No this is not a bug. To calculate the elastic-transformed images <strong class="selflink">bUnwarpJ</strong> needs to interpolate the pixel values, so the first step in the process consists of converting the 8-bit (byte) images into 32-bit (float). You may want to convert them back to 8-bit after registration (Image &gt; Type &gt; 8-bit) and adjust the contrast (Process &gt; Enhance Contrast).
</p>
<h3><span class="mw-headline" id="How_do_I_integrate_the_SIFT.2FMOPS_results_into_bUnwarpJ.3F">How do I integrate the SIFT/MOPS results into bUnwarpJ?</span></h3>
<p>If you are using the ImageJ graphical interface, wait until the SIFT/MOPS plugin shows the results and then call immediately <strong class="selflink">bUnwarpJ</strong>. The correspondences found after the SIFT or MOPS algorithms are automatically converted into <strong class="selflink">bUnwarpJ</strong> landmarks. Please, be aware that if you touch any of the input images before calling <strong class="selflink">bUnwarpJ</strong> you will probably loose the point selections (SIFT/MOPS correspondences) of that image and then no landmark will be displayed.
</p><p>If you do a macro call or use the method bUnwarpJ_.alignImagesBatch, the landmarks will be read as well from the point selections of the input images.
</p><p>If you are calling <strong class="selflink">bUnwarpJ</strong> from the command line, you will have to save the SIFT/MOPS point selections in a file and use the file name in the command line call.
</p>
<h3><span class="mw-headline" id="What_does_.22source_and_target.22_mean.3F_Which_image_is_being_transformed.3F">What does "source and target" mean? Which image is being transformed?</span></h3>
<p>The "source" image is the image being transformed, i.e. the <i>moving image</i>, while the "target" image is the <i>fixed image</i>. In the "Accurate" and "Fast" modes, both images work as source and target.
</p>
<h3><span class="mw-headline" id="What_is_the_format_of_the_raw_transformation_file.3F">What is the format of the raw transformation file?</span></h3>
<p>The raw transformation file should be a text file with the following structure:
</p>
<pre class="brush:plain">
Width=[TARGET IMAGE WITH]
Height=[TARGET IMAGE HEIGHT]

X Trans -----------------------------------
   [(Height * Width) coordinates representing the X transformation for every pixel on the target image]
   
Y Trans -----------------------------------
   [(Height * Width) coordinates representing the Y transformation for every pixel on the target image]
</pre>
<h2><span class="mw-headline" id="References_.28Citation.29">References (Citation)</span></h2>
<p>The algorithm implemented on bUnwarpJ and its technical explanations are detailed on a publication. If you use it successfully for your research please be so kind to cite our work:
</p>
<ul><li> I. Arganda-Carreras, C. O. S. Sorzano, R. Marabini, J.-M. Carazo, C. Ortiz-de Solorzano, and J. Kybic, <a rel="nofollow" class="external text" href="http://cmp.felk.cvut.cz/ftp/articles/kybic/Arganda-CVAMIA2006.pdf">"Consistent and Elastic Registration of Histological Sections using Vector-Spline Regularization,"</a> Lecture Notes in Computer Science, Springer Berlin / Heidelberg, volume 4241/2006, CVAMIA: Computer Vision Approaches to Medical Image Analysis, pages 85-95, 2006.</li></ul>
<p>The related paper of the previous work (<a href="UnwarpJ" title="UnwarpJ">UnwarpJ</a>) is:
</p>
<ul><li> C.Ó. Sánchez Sorzano, P. Thévenaz, M. Unser, "Elastic Registration of Biological Images Using Vector-Spline Regularization", IEEE Transactions on Biomedical Engineering, vol. 52, no. 4, pp. 652-663, April 2005.</li></ul>
<h2><span class="mw-headline" id="License">License</span></h2>
<p>This program is <b>free software</b>; you can redistribute it and/or modify it under the terms of the <b>GNU General Public License</b> as published by the Free Software Foundation (<a rel="nofollow" class="external free" href="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</a>).
</p><p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  
</p>
<h2><span class="mw-headline" id="Acknowledgements">Acknowledgements</span></h2>
<p><strong class="selflink">bUnwarpJ</strong> has been developed during several years already and many people need to be acknowledged for:
</p><p>It started as an extension of <a href="UnwarpJ" title="UnwarpJ">UnwarpJ</a> from <a rel="nofollow" class="external text" href="http://biocomp.cnb.csic.es/~coss/">Carlos O. S. Sorzano</a> and thanks to him and <a rel="nofollow" class="external text" href="http://cmp.felk.cvut.cz/~kybic/">Jan Kybic</a> at the <a rel="nofollow" class="external text" href="http://cmp.felk.cvut.cz/">Center for Machine Perception</a> in Prague, <strong class="selflink">bUnwarpJ</strong> was born in the summer 2005 and published online in 2006.
</p><p>Many of the plugin updates and improvements would have never been possible without the <a href="Hackathon" title="Hackathon">hackathons</a> that took place in <a rel="nofollow" class="external text" href="https://www.janelia.org/">Janelia Research Campus</a> (Virginia, summer 2008) and the <a rel="nofollow" class="external text" href="https://www.ini.uzh.ch/">Institute of Neuroinformatics</a> (Zürich, winter 2008).
</p><p><a rel="nofollow" class="external text" href="http://albert.rierol.net/">Albert Cardona</a> organized the hackathons and is responsible for the code parallelization and javascripting support.
</p><p><a rel="nofollow" class="external text" href="https://www.hhmi.org/scientists/stephan-saalfeld">Stephan Saalfeld</a> made the SIFT/MOPS support possible.
</p><p><a rel="nofollow" class="external text" href="https://www.janelia.org/people/marta-rivera-alba">Marta Rivera-Alba</a> helped with the macro support and code debugging.
</p><p><a rel="nofollow" class="external text" href="https://github.com/dscho">Johannes Schindelin</a> is responsible for the Fiji integration and he is simply there whenever a Java problem comes up!
</p>
<hr />

<!-- 
NewPP limit report
Cached time: 20200713064548
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.176 seconds
Real time usage: 0.180 seconds
Preprocessor visited node count: 3536/1000000
Preprocessor generated node count: 5041/1000000
Post‐expand include size: 5698/2097152 bytes
Template argument size: 1502/2097152 bytes
Highest expansion depth: 12/40
Expensive parser function count: 0/3
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%  107.791      1 - -total
100.00%  107.791      1 - Template:ComponentStats:sc.fiji:bUnwarpJ
 98.43%  106.094      1 - Template:Component
 81.42%   87.762     13 - Template:Person
  2.34%    2.523      1 - Template:GitHub
  1.68%    1.809      1 - Template:Maven
  1.45%    1.559      1 - Template:Project
  1.41%    1.522      1 - Template:SupportStatus
  1.36%    1.469      1 - Template:DevStatus
-->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="index.php?title=BUnwarpJ&amp;oldid=40862">http://imagej.net/index.php?title=BUnwarpJ&amp;oldid=40862</a>"</div>
							</div>

			<div id="footer">
				<p> This page was last modified on 28 October 2019, at 08:39.</p><ul><li><a href="./ImageJ:Privacy_policy" title="ImageJ:Privacy policy">Privacy policy</a></li><li><a href="./ImageJ:About" class="mw-redirect" title="ImageJ:About">About ImageJ</a></li><li><a href="Imprint" title="Imprint">Imprint</a></li></ul>			</div>

			<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="./Category:Plugins" title="Category:Plugins">Plugins</a></li><li><a href="./Category:Registration" title="Category:Registration">Registration</a></li><li><a href="./Category:Citable" title="Category:Citable">Citable</a></li></ul></div></div>		</div>

		<div id="bottom-wrap">
			<div id="footer-wrap-inner">
				<div id="ternary" class="footer">
					<ul>
						<li class="widget">
							<img id="logo" src="skins/imagej-128.png" alt="">
						</li>
					</ul>
				</div>
			</div>
		</div>
		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.loader.load(["ext.fancytree","ext.suckerfish","mediawiki.toc","mediawiki.action.view.postEdit","site","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","ext.SimpleTooltip"]);});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":383});});</script>
		</body>
		</html>
		