<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>2014-07-11 - Fiji won't quit! - ImageJ</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"2014-07-11_-_Fiji_won't_quit!","wgTitle":"2014-07-11 - Fiji won't quit!","wgCurRevisionId":41187,"wgRevisionId":41187,"wgArticleId":2272,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["News"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"2014-07-11_-_Fiji_won't_quit!","wgRelevantArticleId":2272,"wgRequestId":"2b1a879190e25c5afb10f350","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgPreferredVariant":"en","fancytree_path":"/extensions/TreeAndMenu/fancytree"});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user.cssprefs":"ready","user":"ready","user.options":"loading","user.tokens":"loading","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","skins.erudite":"ready"});mw.loader.implement("user.options@0j3lz3q",function($,jQuery,require,module){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens@1ku9xth",function ( $, jQuery, require, module ) {
mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});/*@nomin*/;

});mw.loader.load(["mediawiki.page.startup"]);});</script>
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%252Cshared%257Cmediawiki.sectionAnchor%257Cskins.erudite&amp;only=styles&amp;skin=erudite.css"/>
<script async="" src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=erudite"></script>
<link rel="stylesheet" href="extensions/TreeAndMenu/fancytree/fancytree.css"/><link rel="stylesheet" href="extensions/TreeAndMenu/suckerfish/suckerfish.css"/>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=erudite.css"/>
<meta name="generator" content="MediaWiki 1.28.0"/>
<meta name="description" content="Since releasing ImageJ2 into the wild, there has been a tremendous amount of user feedback. For those who have reported bugs: thank you!"/>
<link rel="shortcut icon" href="skins/ij2.ico"/>
	<meta property="og:type" content="article"/>

	<meta property="og:site_name" content="ImageJ"/>

	<meta property="og:title" content="2014-07-11 - Fiji won't quit!"/>

	<meta property="og:description" content="Since releasing ImageJ2 into the wild, there has been a tremendous amount of user feedback. For those who have reported bugs: thank you!"/>


<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-2014-07-11_-_Fiji_won_t_quit rootpage-2014-07-11_-_Fiji_won_t_quit skin-erudite action-view">
		<div class="mw-jump">
			<a href="2014-07-11_-_Fiji_won't_quit!.html#bodyContent">Skip to content</a>, 			<a href="2014-07-11_-_Fiji_won't_quit!.html#search">Skip to search</a>
		</div>

		<div id="top-wrap" role="banner">
			<h1><a href="Welcome" title="ImageJ" rel="home">ImageJ</a></h1>
			<div id="tagline">From ImageJ</div>

			<a id="menubutton" href="2014-07-11_-_Fiji_won't_quit!.html#menu">Menu</a>
			<div id="nav" role="navigation">
			<ul id='menu'>
<li id="menu-item-n-About"><a href="ImageJ">About</a></li>
<li id="menu-item-n-Downloads"><a href="Downloads">Downloads</a></li>
<li id="menu-item-n-Learn"><a href="Learn">Learn</a></li>
<li id="menu-item-n-Develop"><a href="Development">Develop</a></li>
<li id="menu-item-n-News"><a href="News">News</a></li>
<li id="menu-item-n-Events"><a href="Events">Events</a></li>
<li id="menu-item-n-Help"><a href="Help">Help</a></li>
</ul>
			</div>
		</div>

		<div id="mw-js-message"></div>
		
		<div id="main" role="main">

			<div id="bodyContent">
				<h1>2014-07-11 - Fiji won't quit!</h1>
				
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="2014-07-11_-_Fiji_won't_quit!.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="2014-07-11_-_Fiji_won't_quit!.html#Being_unable_to_quit"><span class="tocnumber">2</span> <span class="toctext">Being unable to quit</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="2014-07-11_-_Fiji_won't_quit!.html#Process_not_terminating"><span class="tocnumber">3</span> <span class="toctext">Process not terminating</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="2014-07-11_-_Fiji_won't_quit!.html#Other_complications"><span class="tocnumber">4</span> <span class="toctext">Other complications</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="2014-07-11_-_Fiji_won't_quit!.html#Conclusion"><span class="tocnumber">5</span> <span class="toctext">Conclusion</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>Since <a href="2014-06-04_-_ImageJ_2.0.0_release_candidate" title="2014-06-04 - ImageJ 2.0.0 release candidate">releasing ImageJ2 into the wild</a>, there has been a tremendous amount of user feedback. For those who have <a href="Report_a_Bug" title="Report a Bug">reported bugs</a>: thank you!
</p><p>Of all the issues reported, one has stood out as the most tenacious and difficult to solve: <a rel="nofollow" class="external text" href="https://fiji.sc/bugzilla/show_bug.cgi?id=805">Fiji bug #805, "Fiji not closing"</a>, colloquially known as the "Fiji won't quit!" problem. (Actually, versions of this bug existed before bug #805 was reported, but that bug is where we have been tracking the issue most recently.)
</p><p>As of this writing, we have just released ImageJ 2.0.0-rc-9 which we believe finally solves this issue after <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/f2ba2b2645fe6aa5f0a0b5591defd37881dba31f">six</a> <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/c441b81ac5b830ee8752038b3d9d86858b552634">different</a> <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/8af9bfc4a0010374fa2390041c3735a7bbcc7e6f">attempts</a> <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/62259dab7bbe70064ccaed621ac3940ffc6aaf61">to</a> <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/fe237a23fbde86171b8d574bdeb9c34a397dcfff">fix</a> <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/1f9b76f270e08a9c50abaf09c5938c4e08733892">it</a>.
</p><p>There were actually two different classes of misbehavior:
</p>
<ol><li> <b>Being unable to quit.</b> The main window refuses to disappear, and the program becomes largely nonfunctional from that point forward and must be force closed.</li>
<li> <b>Process not terminating.</b> ImageJ completes its shutdown routine and all windows disappear, but the Java process continues running in the background because <code>System.exit(0)</code> is never called.</li></ol>
<h2><span class="mw-headline" id="Being_unable_to_quit">Being unable to quit</span></h2>
<p>This class of bug was introduced because <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/11fa5cb86112ae381448bf15a40fa29aeb32d553">we tried to improve upon ImageJ1's behavior relating to the closing of windows and dialogs</a>. It was previously the case that if you quit ImageJ while the <a href="Script_Editor" class="mw-redirect" title="Script Editor">Script Editor</a> had tabs with unsaved changes, those changes would be discarded with no chance to save first. The behavior of ImageJ1 with other types of "non-sanctioned" windows (i.e., <a rel="nofollow" class="external text" href="https://github.com/imagej/ImageJA/blob/v1.49d/src/main/java/ij/WindowManager.java#L393-L400">all <code>Window</code> instances other than <code>ImageWindow</code>, <code>TextWindow</code> or non-<code>Editor</code> <code>PlugInFrame</code></a>) is to dispose them immediately without warning just prior to shutdown.
</p><p>To address the problem, we <a rel="nofollow" class="external text" href="https://github.com/imagej/ij1-patcher/commit/7b202c6c826e870c23a1fb0b91ebb86c217c133c">added a callback hook to ImageJ1</a> on the <code>WindowManager.closeAllWindows()</code> method, so that we could inject additional behavior. We then <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/11fa5cb86112ae381448bf15a40fa29aeb32d553#diff-fb9b7c8be0fd7333a89ddb85e48390e5R508">dispatched a windowClosing event to each remaining window</a> to give them a chance to opt out of being closed. But it turns out that Java's standard paradigm of allowing windows to cancel their own closing conflates the ideas of confirming the close (e.g., with the user) with the process of actually doing the close/dispose on the window afterward. The approach proved too fragile and prone to deadlocks, so we ended up opting for a <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/a1b3987e0302c270f80b0847ce86ca1ce1dd6861">different approach</a> instead. With a <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-ui-swing/commit/b830cf749115065407564e3c5a65dae3ec74ab09">minor update to the Script Editor</a>, its windows now still prompt to save changes when quitting (whoo hoo!), but without the fragility of the original approach.
</p>
<h2><span class="mw-headline" id="Process_not_terminating">Process not terminating</span></h2>
<p>The second class of problem was introduced because ImageJ2 does not launch ImageJ via the <a rel="nofollow" class="external text" href="https://github.com/imagej/ImageJA/blob/v1.49d/src/main/java/ij/ImageJ.java#L624"><code>ij.ImageJ.main</code></a> method. There are several reasons for this from an architectural and technical standpoint, which are outside the scope of this blog post. But suffice to say that <code>ij.ImageJ.main</code> performs many actions which the ImageJ2 startup routine also needs to perform (but not in exactly the same way), such as handling command line arguments, most of which we covered&#8212;except for <a rel="nofollow" class="external text" href="https://github.com/imagej/ImageJA/blob/v1.49d/src/main/java/ij/ImageJ.java#L666">a call setting the <code>exitWhenQuitting</code> flag to true</a>. By default, ImageJ1 does <i>not</i> call <code>System.exit(0)</code> when quitting, but whenever it is launched via its main method, it does. So even after <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/428b93d7420649f843128fb9a992f53579105d39">we updated ImageJ2's quitting routine to lean on ImageJ1 as much as possible</a> (which seemed to fix the problem in many of our tests), it was still not always enough since <code>System.exit(0)</code> was never ultimately called. We fixed this discrepancy in the ImageJ legacy layer by <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/fe237a23fbde86171b8d574bdeb9c34a397dcfff">always setting exitWhenQuitting to true</a> as well.
</p>
<h2><span class="mw-headline" id="Other_complications">Other complications</span></h2>
<p>There were other considerations too, of course. It needs to be possible to:
</p>
<ol><li> Shut down ImageJ through the UI via the ImageJ1-based code path of <a rel="nofollow" class="external text" href="https://github.com/imagej/ImageJA/blob/v1.49d/src/main/java/ij/ImageJ.java#L603">ij.ImageJ#quit()</a>.</li>
<li> Dispose of ImageJ programmatically via the ImageJ2-based code path of <a rel="nofollow" class="external text" href="https://github.com/scijava/scijava-common/blob/scijava-common-2.27.0/src/main/java/org/scijava/Context.java#L367">org.scijava.Context#dispose()</a> which in turn <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/blob/imagej-legacy-0.5.20/src/main/java/net/imagej/legacy/DefaultLegacyService.java#L402">disposes the <code>LegacyService</code> and hence ImageJ1</a>.</li></ol>
<p>These two code paths need to behave very differently. In the case of (1), ImageJ1's quitting routine happens, but some extra logic is injected to handle window closing better (see "Being unable to quit" above) as well as shut down the ImageJ2 application context in addition to ImageJ1 itself. In the case of (2), ImageJ2 disposes its entire context including the <code>LegacyService</code> which is responsible for managing ImageJ1, meaning that ImageJ1 gets disposed as <i>part of</i> ImageJ2's disposal&#8212;all of which must <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/blob/imagej-legacy-0.6.0/src/main/java/net/imagej/legacy/IJ1Helper.java#L199-L219">happen <i>without</i> calling <code>System.exit(0)</code> and <i>without</i> prompting the user to save any changes</a>.
</p>
<h2><span class="mw-headline" id="Conclusion">Conclusion</span></h2>
<p>We believe we have finally ironed out all these problems, but as the above explanation hopefully conveys, ImageJ1 is fraught with multiple code paths, and quitting the program is no exception. Searching the ImageJ1 codebase for <code>System.exit(0)</code> yields five separate places where it gets called, one of which, astonishingly, is a <a rel="nofollow" class="external text" href="https://github.com/imagej/ImageJA/blob/v1.49d/src/main/java/ij/IJ.java#L1464">potential code path of the <code>ij.IJ#getImage()</code> method</a>! Adding on the ImageJ legacy layer on top is a very complex endeavor, but we are proud to say that instances of ImageJ2 can be cleanly disposed of <i>without</i> shutting down the entire JVM, which provides a substantial boost to ImageJ's usability as a software library.
</p><p>P.S. We <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/8ead1c0a5eeb1a040d2eb473d8420c695a487709">added regression tests</a> for all the major scenarios, even including <a rel="nofollow" class="external text" href="https://github.com/imagej/imagej-legacy/commit/3dedc32cb4609f2840db65947d6adedbcba29400">an integration test for verifying that <code>System.exit(0)</code> is called</a> under the correct circumstances.
</p><p>P.P.S. The "Fiji won't quit" T-shirt is coming soon!&#160;:-)
</p>
<!-- 
NewPP limit report
Cached time: 20200713064341
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.016 seconds
Real time usage: 0.017 seconds
Preprocessor visited node count: 208/1000000
Preprocessor generated node count: 832/1000000
Post‐expand include size: 2042/2097152 bytes
Template argument size: 1168/2097152 bytes
Highest expansion depth: 3/40
Expensive parser function count: 0/3
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%    5.838      1 - -total
 88.07%    5.142      8 - Template:GitHub
-->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="index.php?title=2014-07-11_-_Fiji_won%27t_quit!&amp;oldid=41187">http://imagej.net/index.php?title=2014-07-11_-_Fiji_won%27t_quit!&amp;oldid=41187</a>"</div>
							</div>

			<div id="footer">
				<p> This page was last modified on 24 January 2020, at 11:53.</p><ul><li><a href="./ImageJ:Privacy_policy" title="ImageJ:Privacy policy">Privacy policy</a></li><li><a href="./ImageJ:About" class="mw-redirect" title="ImageJ:About">About ImageJ</a></li><li><a href="Imprint" title="Imprint">Imprint</a></li></ul>			</div>

			<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="./Category:News" title="Category:News">News</a></li></ul></div></div>		</div>

		<div id="bottom-wrap">
		</div>
		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.loader.load(["ext.fancytree","ext.suckerfish","mediawiki.toc","mediawiki.action.view.postEdit","site","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","ext.SimpleTooltip"]);});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":209});});</script>
		</body>
		</html>
		