<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Javassist - ImageJ</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Javassist","wgTitle":"Javassist","wgCurRevisionId":12315,"wgRevisionId":12315,"wgArticleId":1375,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Development"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Javassist","wgRelevantArticleId":1375,"wgRequestId":"1b97fee29215c53953cbce2f","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgPreferredVariant":"en","fancytree_path":"/extensions/TreeAndMenu/fancytree"});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user.cssprefs":"ready","user":"ready","user.options":"loading","user.tokens":"loading","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","skins.erudite":"ready"});mw.loader.implement("user.options@0j3lz3q",function($,jQuery,require,module){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens@1ku9xth",function ( $, jQuery, require, module ) {
mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});/*@nomin*/;

});mw.loader.load(["mediawiki.page.startup"]);});</script>
<link rel="stylesheet" href="../load.php%3Fdebug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%252Cshared%257Cmediawiki.sectionAnchor%257Cskins.erudite&amp;only=styles&amp;skin=erudite.css"/>
<script async="" src="../load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=erudite"></script>
<link rel="stylesheet" href="../extensions/TreeAndMenu/fancytree/fancytree.css"/><link rel="stylesheet" href="../extensions/TreeAndMenu/suckerfish/suckerfish.css"/>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="../load.php%3Fdebug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=erudite.css"/>
<meta name="generator" content="MediaWiki 1.28.0"/>
<meta name="description" content="Javassist is a Java library to generate, modify and inspect bytecode (i.e. the machine language of Java)."/>
<link rel="shortcut icon" href="../skins/ij2.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="ImageJ (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="ImageJ Atom feed" href="index.php?title=Special:RecentChanges&amp;feed=atom"/>

<script type="text/javascript" src="../extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="../extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushJava.js"></script>
<script type="text/javascript" src="../extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushBash.js"></script>
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<link rel="stylesheet" type="text/css" media="screen" href="../extensions/SyntaxHighlighter/syntaxhighlighter/styles/shCoreMinit.css" />

	<meta property="og:type" content="article"/>

	<meta property="og:site_name" content="ImageJ"/>

	<meta property="og:title" content="Javassist"/>

	<meta property="og:description" content="Javassist is a Java library to generate, modify and inspect bytecode (i.e. the machine language of Java)."/>

	<meta property="og:url" content="http://imagej.net/Javassist"/>

<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Javassist rootpage-Javassist skin-erudite action-view">
		<div class="mw-jump">
			<a href="Javassist.html#bodyContent">Skip to content</a>, 			<a href="Javassist.html#search">Skip to search</a>
		</div>

		<div id="top-wrap" role="banner">
			<h1><a href="Welcome" title="ImageJ" rel="home">ImageJ</a></h1>
			<div id="tagline">From ImageJ</div>

			<a id="menubutton" href="Javassist.html#menu">Menu</a>
			<div id="nav" role="navigation">
			<ul id='menu'>
<li id="menu-item-n-About"><a href="ImageJ">About</a></li>
<li id="menu-item-n-Downloads"><a href="Downloads">Downloads</a></li>
<li id="menu-item-n-Learn"><a href="Learn">Learn</a></li>
<li id="menu-item-n-Develop"><a href="Development">Develop</a></li>
<li id="menu-item-n-News"><a href="News">News</a></li>
<li id="menu-item-n-Events"><a href="Events">Events</a></li>
<li id="menu-item-n-Help"><a href="Help">Help</a></li>
</ul>
			</div>
		</div>

		<div id="mw-js-message"></div>
		
		<div id="main" role="main">
			<div id="nav-meta">
			<span id="ca-nstab-main" class="selected"><a href="Javassist" title="View the content page [c]" accesskey="c">Page</a></span><span class="meta-sep">|</span><span id="ca-talk" class="new"><a href="index.php?title=Talk:Javassist&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page [t]" accesskey="t">Discussion</a></span><span class="meta-sep">|</span><span id="ca-viewsource"><a href="index.php?title=Javassist&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span><span class="meta-sep">|</span><span id="ca-history"><a href="index.php?title=Javassist&amp;action=history" title="Past revisions of this page [h]" accesskey="h">History</a></span><span class="meta-sep">|</span>			</div>

			<div id="bodyContent">
				<h1>Javassist</h1>
				
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><p><a rel="nofollow" class="external text" href="http://www.javassist.org">Javassist</a> is a Java library to generate, modify and inspect bytecode (i.e. the machine language of Java).
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Javassist.html#Quick_example"><span class="tocnumber">1</span> <span class="toctext">Quick example</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Javassist.html#Code_editing"><span class="tocnumber">2</span> <span class="toctext">Code editing</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="Javassist.html#Wrapping_existing_code_blocks"><span class="tocnumber">2.1</span> <span class="toctext">Wrapping existing code blocks</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="Javassist.html#Debugging"><span class="tocnumber">3</span> <span class="toctext">Debugging</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="Javassist.html#VerifyError"><span class="tocnumber">4</span> <span class="toctext">VerifyError</span></a></li>
</ul>
</div>

<h1><span class="mw-headline" id="Quick_example">Quick example</span></h1>
<p>Let's assume that you want to know which call paths lead to a given method (e.g. <i>foo()</i>) in a given class (e.g. <i>org.soft.micro.Narf</i>). 
</p>
<pre class="brush:java">
// get the class pool
ClassPool pool = ClassPool.getDefault();
// access the class without loading it just yet
CtClass clazz = pool.get("org.soft.micro.Narf");
// get the method; you can find the signature (2nd parameter) like this:
// fiji --javap -s org.soft.micro.Narf | grep -A1 foo
CtMethod method = clazz.getMethod("foo", "()V");
// now let's output a whole lot of stuff whenever this method is entered
method.insertBefore("new Exception(\"Here I am!\").printStackTrace();");
</pre>
<p>Of course, you are not limited to outputting a stack trace. You could also generate Strings of those traces and put them into a Map, possibly counting the occurrences.
</p><p>Other useful actions include inspecting the parameters passed to the method which you can access by the special names <i>$1</i>, <i>$2</i>, ...
</p><p>Further reading: Javassist's <a rel="nofollow" class="external text" href="http://www.csg.is.titech.ac.jp/~chiba/javassist/tutorial/tutorial.html">online tutorial</a>.
</p>
<h1><span class="mw-headline" id="Code_editing">Code editing</span></h1>
<p>While Javassist allows to edit bytecode directly, its most powerful feature is that it allows you to modify methods using snippets of Java code. There are two slightly different methods to do so: the <a rel="nofollow" class="external text" href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/index.html">CodeConverter</a> and the <a rel="nofollow" class="external text" href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/expr/ExprEditor.html">ExprEditor</a> (it depends which one to use, <i>CodeConverter</i> is easier to use but <i>ExprEditor</i> is more powerful.
</p>
<h2><span class="mw-headline" id="Wrapping_existing_code_blocks">Wrapping existing code blocks</span></h2>
<p>A common reason for Javassist'ing code is to handle previously unhandled exceptions, or to make certain parts of the code conditional. As an example, we demonstrate here how, say, a hypothetical <i>OpenAccess'</i> <i>toString()</i> method could be protected against a <i>NullPointerException</i>:
</p>
<pre class="brush:java">
// get the class pool
ClassPool pool = ClassPool.getDefault();
// access the class without loading it just yet
CtClass clazz = pool.get("OpenAccess");
CtMethod method = clazz.getMethod("toString", "()Ljava/lang/String;");
// now let's handle NullPointerExceptions
method.setBody("try {"
  + "  $_ = $proceed($$);"
  + "} catch (java.lang.NullPointerException e) {"
  + "  return \"(null)\";"
  + "}");
</pre>
<p>Note that the special <tt>$_ = $proceed($$)</tt> is a Javassist-specific syntax referring to the original code. See <a rel="nofollow" class="external text" href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/tutorial/tutorial2.html#before">the Javassist tutorial</a> for details.
</p>
<h1><span class="mw-headline" id="Debugging">Debugging</span></h1>
<p>Javassist has very useful tools for disassembly and introspection. For example, you could inspect the contents of a class using some code like this:
</p>
<pre class="brush:java">
// get the class pool
ClassPool pool = ClassPool.getDefault();
// access the class without loading it just yet
CtClass clazz = pool.get("org.soft.micro.Narf");
// output the contents
ClassFilePrinter.print(clazz.getClassFile());
</pre>
<p>Or you could disassemble a method like this:
</p>
<pre class="brush:java">
// get the class pool
ClassPool pool = ClassPool.getDefault();
// access the class without loading it just yet
CtClass clazz = pool.get("org.soft.micro.Narf");
// get the method
CtMethod method = clazz.getMethod("foo", "()V");
// disassemble the method
InstructionPrinter.print(method, System.err);
</pre>
<p>If you absolutely do not want the output to go to <i>System.err</i>, you could substitute it by <i>new PrintStream(new IJLogOutputStream())</i> (the class <i>IJLogOutputStream</i> is defined in <a href="Update_Fiji" class="mw-redirect" title="Update Fiji">Fiji Updater</a>'s <i>fiji.updater.util</i> class for you to reuse).
</p>
<h1><span class="mw-headline" id="VerifyError">VerifyError</span></h1>
<p>For security reasons, HotSpot does not allow any malformed bytecode to execute. To verify that the bytecode is reasonably sane, the code is <i>verified</i> before being executed.
</p><p>Unfortunately, the error messages of said verifier are not exactly stellar.
</p><p>If you want to avoid being misled by the error message (the method mentioned in the <i>VerifyError</i> is most likely to be <u>not</u> the offending one), and moreover want to know where in the bytecode the error happened, probably the easiest way to go forward is to use <a rel="nofollow" class="external text" href="http://commons.apache.org/bcel/">BCEL</a> (you can get it directly from the <a rel="nofollow" class="external text" href="http://maven.imagej.net/index.html#nexus-search;gav%7E%7Ebcel%7E%7E%7E">Maven repository</a>), Apache's <i>Byte Code Engineering Library</i>. For that, you have to write out .class files first:
</p>
<pre class="brush:java">
CtClass clazz = ...;
...;

File directory = ...;
File file = new File(directory, clazz.getName().replace('.', '/') + ".class");
file.getParentFile().makeDirectories();
DataOutputStream out = new DataOutputStream(new FileOutputStream(file));
clazz.getClassFile().write(out);
out.close();
</pre>
<p>Then you can use the verifier:
</p>
<pre class="brush:bash">
fiji --classpath=/path/to/bcel.jar:directory/ \
        --main-class=org.apache.bcel.verifier.Verifier \
        my.class.Name
</pre>
<p>(Side note: Apache calls the verifier <i>JustIce</i>, but the name is not reflected in the program name, only in its output.)
</p><p>More on this issue can be found <a rel="nofollow" class="external text" href="http://elliotth.blogspot.com/2008/03/generating-jvm-bytecode.html">here</a>.
</p><p>Side note: the ASM component (which is included in JRuby, which in turn is included in Fiji) also has a verifier. You can start it with some command-line invocation similar to this:
</p>
<pre class="brush:bash">
fiji --classpath /path/to/classes \
        --main-class jruby.objectweb.asm.util.CheckClassAdapter \
        my.class.Name
</pre>
<p>If you are using Fiji's <a rel="nofollow" class="external text" href="https://github.com/fiji/fiji-compat/blob/master/src/main/java/fiji/JavassistHelper.java">JavassistHelper class</a>, you can use the <i>verify()</i> method which does nothing else than to hand off to the ASM component's verifier. Example:
</p>
<pre class="brush:java">
import fiji.JavassistHelper;
import javassist.ClassPool;

...

  ClassPool.getDefault().addClassPath("/path/to/my.jar");
  JavassistHelper helper = new JavassistHelper();
  // hack away
  helper.verify(hacker.get("the.class.in.question"), System.err);
...
</pre>

<!-- 
NewPP limit report
Cached time: 20200713072803
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.012 seconds
Real time usage: 0.011 seconds
Preprocessor visited node count: 87/1000000
Preprocessor generated node count: 504/1000000
Post‐expand include size: 196/2097152 bytes
Template argument size: 86/2097152 bytes
Highest expansion depth: 3/40
Expensive parser function count: 0/3
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%    2.257      1 - Template:GitHub
100.00%    2.257      1 - -total
-->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="index.php?title=Javassist&amp;oldid=12315">http://imagej.net/index.php?title=Javassist&amp;oldid=12315</a>"</div>
							</div>

			<div id="footer">
				<p> This page was last modified on 13 October 2014, at 14:51.</p><ul><li><a href="ImageJ:Privacy_policy" title="ImageJ:Privacy policy">Privacy policy</a></li><li><a href="ImageJ:About" class="mw-redirect" title="ImageJ:About">About ImageJ</a></li><li><a href="Imprint" title="Imprint">Imprint</a></li><li><a href="index.php?title=Javassist&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li></ul>			</div>

			<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="Special:Categories" title="Special:Categories">Category</a>: <ul><li><a href="Category:Development" title="Category:Development">Development</a></li></ul></div></div>		</div>

		<div id="bottom-wrap">
		<div id="footer-wrap-inner">

		<div id="primary" class="footer">
			<ul>

			<li id="search" class="widget">
				<h3>Search</h3>
				<form action="http://imagej.net/index.php" id="searchform">
					<input type='hidden' name="title" value="Special:Search" />
					<div>
						<input name="search" placeholder="Search ImageJ" title="Search ImageJ [f]" accesskey="f" id="s"/>						<input type="submit" name="go" value="Search" title="Go to a page with this exact name if it exists" class="searchButton" id="searchsubmit"/>					</div>
				</form>
			</li>

			
						<li class="widget">
				<h3>Personal tools</h3>
				<div>
					<ul>
					<li id="pt-createaccount"><a href="index.php?title=Special:CreateAccount&amp;returnto=Javassist" title="You are encouraged to create an account and log in; however, it is not mandatory">Create account</a></li><li id="pt-login"><a href="index.php?title=Special:UserLogin&amp;returnto=Javassist" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>					</ul>
				</div>
			</li>
			
			<li class="widget">
							</li>

			</ul>
		</div>

		<div id="secondary" class="footer">
			<ul>

			<li id="toolbox" class="widget">
				<h3>Tools</h3>
				<ul>
				<li id="t-whatlinkshere"><a href="Special:WhatLinksHere/Javassist" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="Special:RecentChangesLinked/Javassist" rel="nofollow" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="index.php?title=Javassist&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="index.php?title=Javassist&amp;oldid=12315" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="index.php?title=Javassist&amp;action=info" title="More information about this page">Page information</a></li>				</ul>
			</li>

			
			<li class="widget">
							</li>

			</ul>
		</div>

		<div id="ternary" class="footer">
			<ul>

			<li class="widget">
				<img id="logo" src="../skins/imagej-128.png" alt=""/>			</li>

			<li class="widget">
				<h3><span class="mw-headline" id="MORE_TOOLS">MORE TOOLS</span></h3>
<ul><li> <a href="Special:ChangeUploadPassword" title="Special:ChangeUploadPassword">Set/change upload password</a></li>
<li> <a href="Special:RecentChanges" title="Special:RecentChanges">Recent changes</a></li>
<li> <a href="Special:LonelyPages" title="Special:LonelyPages">Orphaned pages</a></li></ul>
			</li>

			</ul>
		</div>
		<div style="clear: both"></div>

		</div>
		</div>

		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.loader.load(["ext.fancytree","ext.suckerfish","mediawiki.toc","mediawiki.action.view.postEdit","site","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","ext.SimpleTooltip"]);});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":201});});</script>
		</body>
		</html>
		