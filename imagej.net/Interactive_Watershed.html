<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Interactive Watershed - ImageJ</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Interactive_Watershed","wgTitle":"Interactive Watershed","wgCurRevisionId":38303,"wgRevisionId":38303,"wgArticleId":7676,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Plugins","Segmentation"],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Interactive_Watershed","wgRelevantArticleId":7676,"wgRequestId":"e8937a4c3f7e41ec71b60931","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgPreferredVariant":"en","fancytree_path":"/extensions/TreeAndMenu/fancytree"});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user.cssprefs":"ready","user":"ready","user.options":"loading","user.tokens":"loading","ext.math.styles":"ready","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","skins.erudite":"ready"});mw.loader.implement("user.options@0j3lz3q",function($,jQuery,require,module){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens@1ku9xth",function ( $, jQuery, require, module ) {
mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});/*@nomin*/;

});mw.loader.load(["mediawiki.page.startup"]);});</script>
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=ext.math.styles%257Cmediawiki.legacy.commonPrint%252Cshared%257Cmediawiki.sectionAnchor%257Cskins.erudite&amp;only=styles&amp;skin=erudite.css"/>
<script async="" src="load.php%3Fdebug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=erudite"></script>
<link rel="stylesheet" href="extensions/TreeAndMenu/fancytree/fancytree.css"/><link rel="stylesheet" href="extensions/TreeAndMenu/suckerfish/suckerfish.css"/>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="load.php%3Fdebug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=erudite.css"/>
<meta name="generator" content="MediaWiki 1.28.0"/>
<meta name="description" content="Watershed [Vincent 1991] is a common tool to segment objects in an 2D and 3D images. It is relatively fast and can provides understandable and robust results which can be used for image analysis."/>
<link rel="shortcut icon" href="skins/ij2.ico"/>

<script type="text/javascript" src="extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushPlain.js"></script>
<script type="text/javascript" src="extensions/SyntaxHighlighter/syntaxhighlighter/scripts/shBrushPython.js"></script>
<script type="text/javascript">
SyntaxHighlighter.all();
</script>
<link rel="stylesheet" type="text/css" media="screen" href="extensions/SyntaxHighlighter/syntaxhighlighter/styles/shCoreMinit.css" />

	<meta property="og:type" content="article"/>

	<meta property="og:site_name" content="ImageJ"/>

	<meta property="og:title" content="Interactive Watershed"/>

	<meta property="og:description" content="Watershed [Vincent 1991] is a common tool to segment objects in an 2D and 3D images. It is relatively fast and can provides understandable and robust results which can be used for image analysis."/>


<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Interactive_Watershed rootpage-Interactive_Watershed skin-erudite action-view">
		<div class="mw-jump">
			<a href="Interactive_Watershed.html#bodyContent">Skip to content</a>, 			<a href="Interactive_Watershed.html#search">Skip to search</a>
		</div>

		<div id="top-wrap" role="banner">
			<h1><a href="Welcome" title="ImageJ" rel="home">ImageJ</a></h1>
			<div id="tagline">From ImageJ</div>

			<a id="menubutton" href="Interactive_Watershed.html#menu">Menu</a>
			<div id="nav" role="navigation">
			<ul id='menu'>
<li id="menu-item-n-About"><a href="ImageJ">About</a></li>
<li id="menu-item-n-Downloads"><a href="Downloads">Downloads</a></li>
<li id="menu-item-n-Learn"><a href="Learn">Learn</a></li>
<li id="menu-item-n-Develop"><a href="Development">Develop</a></li>
<li id="menu-item-n-News"><a href="News">News</a></li>
<li id="menu-item-n-Events"><a href="Events">Events</a></li>
<li id="menu-item-n-Help"><a href="Help">Help</a></li>
</ul>
			</div>
		</div>

		<div id="mw-js-message"></div>
		
		<div id="main" role="main">

			<div id="bodyContent">
				<h1>Interactive Watershed</h1>
				
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Interactive_Watershed.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="Interactive_Watershed.html#Watershed_principle"><span class="tocnumber">1.1</span> <span class="toctext">Watershed principle</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="Interactive_Watershed.html#H-Maxima_and_H-Watershed"><span class="tocnumber">1.2</span> <span class="toctext">H-Maxima and H-Watershed</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="Interactive_Watershed.html#Usage"><span class="tocnumber">2</span> <span class="toctext">Usage</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="Interactive_Watershed.html#Installation"><span class="tocnumber">2.1</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="Interactive_Watershed.html#User_Interface"><span class="tocnumber">2.2</span> <span class="toctext">User Interface</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="Interactive_Watershed.html#Scripting"><span class="tocnumber">2.3</span> <span class="toctext">Scripting</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8"><a href="Interactive_Watershed.html#Methods_and_Implementation"><span class="tocnumber">3</span> <span class="toctext">Methods and Implementation</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="Interactive_Watershed.html#Heavy_lifting"><span class="tocnumber">3.1</span> <span class="toctext">Heavy lifting</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="Interactive_Watershed.html#Ligthweight_update_of_the_segmentation"><span class="tocnumber">3.2</span> <span class="toctext">Ligthweight update of the segmentation</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="Interactive_Watershed.html#Comment_on_implementation"><span class="tocnumber">3.3</span> <span class="toctext">Comment on implementation</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-12"><a href="Interactive_Watershed.html#References"><span class="tocnumber">4</span> <span class="toctext">References</span></a></li>
<li class="toclevel-1 tocsection-13"><a href="Interactive_Watershed.html#History"><span class="tocnumber">5</span> <span class="toctext">History</span></a></li>
</ul>
</div>

<table class="infobox" cellspacing="5" style="max-width: 31em; font-size: 90%; text-align: left; float: right; border: 1px solid #a0a0a0;">
<tr>
<th colspan="2" style="text-align: center; font-size: 130%;"> <div style="float: left"></div>Interactive H_Watershed (ImageJ/Fiji)<div style="clear: left;"></div>
</th></tr>
<tr>
<th> Author
</th>
<td> <a href="./User:Benoit" title="User:Benoit">Benoit Lombardot</a>
</td></tr>




<tr>
<th> Maintainer
</th>
<td> <a href="./User:Benoit" title="User:Benoit">Benoit Lombardot</a>
</td></tr>

<tr>
<th> File
</th>
<td> SCF-MPI-CBG update site
</td></tr>
<tr>
<th> Source
</th>
<td> <a rel="nofollow" class="external text" href="https://github.com/mpicbg-scicomp/Interactive-H-Watershed/">on GitHub</a>
</td></tr>
<tr>
<th> Initial release
</th>
<td> 08 May 2017
</td></tr>


<tr>
<th> Category
</th>
<td> <a href="./Category:Plugins" title="Category:Plugins">Plugins</a>, <a href="./Category:Segmentation" title="Category:Segmentation">Segmentation</a>
</td></tr>

</table><div class="center"><div class="floatnone"><a href="./File:InteractiveWatershed_illustration.PNG" class="image"><img alt="InteractiveWatershed illustration.PNG" src="_images/5/5f/InteractiveWatershed_illustration.PNG" width="500" height="479" /></a></div></div>
<div align="center"><b>Figure 1:</b> Illustration of the interactive watershed plugin showing the plugin control panel in front of a segmentation overlaying raw microscopy data. The raw data shows a section of a Platynereis embryo during early development. Data were acquired by Mette Handberg-Thorsager (Tomancak lab, MPI-CBG, Dresden and Keller lab, HHMI - Janelia Research Campus)</div>
<h1><span class="mw-headline" id="Introduction">Introduction</span></h1>
<p>Watershed [Vincent 1991] is a common tool to segment objects in an 2D and 3D images. It is relatively fast and can provides understandable and robust results which can be used for image analysis.
</p><p>Creating a good segmentation however requires some expertise and can be time consuming. One has to determine the right threshold to stop the watershed. Meaningful local extrema have to be selected to initiate the algorithm. And once a result is obtained the segmentation has to be compared to the original data. That process can then be iterated till satisfying parameters are found. That procedure can be very time consuming if not provided with practicle tools, especially when image are large and a single watershed can take minutes.
</p><p>The interactive Watershed plugin provides an interactive way to explore local minima (maxima) and threshold, updating the resulting watershed on the fly. This is possible by calculating the watershed only once at plugin initialization. Further when Threshold or maxima selection are updated this initial segmentation is reused to generate the new segmentation instantly. In order to ease quality assessment the results directly overlaid to the data.
</p><p>The 2 following subsection gives additionnal details on watershed working principle and on the strategy used in the plugin for local maxima detection: H-Maxima
</p><p><br />
</p>
<h2><span class="mw-headline" id="Watershed_principle">Watershed principle</span></h2>
<p>If we interpret images as landscapes of hills and valleys, the watershed algorithm gradually flood the valleys starting from their lowest point (the image local minima). When the floodings of two minima meet at a sadle they remain distinct as each minima region is labelled with a distinct color. The flooding stops when all the image is covered. As objects do not always cover the whole image a threshold can be set to stop region the region flooding. Alternatively the flooding can be started from local maxima. Figure 2 shows the flooding of 3 peaks for different values of the treshold parameter.
</p>
<div class="center"><div class="floatnone"><a href="./File:Figure_Watershed.PNG" class="image"><img alt="Figure Watershed.PNG" src="_images/7/73/Figure_Watershed.PNG" width="800" height="232" /></a></div></div>
<div align="center"><b>Figure 2</b> illustrates the flooding of an image by the watershed algorithm. First row shows the flooding of a 2D image while the 2nd row illustrates the process in a 1D image (section along the red cut in the 1st row). 1st column shows the orginal image. 2nd column shows with spot the detection of local minima. Column 3,4,5 show the flooding of the image. If no stopping criteria is used the entire image is flooded (column 5).</div>
<h2><span class="mw-headline" id="H-Maxima_and_H-Watershed">H-Maxima and H-Watershed</span></h2>
<p>An image local maximum (minimum) is a region in the image for which all neighboring pixels have a lower (higher) value. A lot of maxima in an image are simply caused by noise and are not meaningful. If one can select more significant maxima corresponding to objects, they could be used to initiate a watershed segmentation of these objects.
</p><p>There exists many different ways of detecting local maxima. H-maxima focuses on maxima robustness. It has one parameter, H, that can be compared to the amplitude of the noise in the image. H-maxima selects all maxima which are still maxima when their value is decreased by H. When H is increased, less maxima are selected but they end being more robust to noise. Figure 3 shows the maxima selected in a sample image for different H values.
</p><p>We call H-Watershed the segmentation obtained by flooding the H-maxima of an image. Such segmentation has 2 parameters. The Threshold, T, that stops the flooding of the image and the H-maxima robustness, H, that defines the flooding initialization.
</p>
<div class="center"><div class="floatnone"><a href="./File:Figure_HMax_HWatershed_v3.PNG" class="image"><img alt="Figure HMax HWatershed v3.PNG" src="_images/0/05/Figure_HMax_HWatershed_v3.PNG" width="800" height="489" /></a></div></div>
<div align="center"><b>Figure 3</b> illustrates the detection of H-Maxima in 2D, 1D and the resulting 2D watershed (repectively row 1, 2 and 3). The 1st column shows the original data, whereas column 2, 3 and 4 show the H-Maxima and H-Watershed respectively for H values 0, 10 and 40. The threshold value 100 was used for the H-Watershed on row 3. The image used for the illustration is a crop of the blobs image available from ImageJ sample images.</div>
<h1><span class="mw-headline" id="Usage">Usage</span></h1>
<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<p>To install the plugin in your ImageJ or Fiji installation. Add the update site SCF-MPI-CBG. Java8 update site should also be installed if it is not there yet. The procedure to follow an update site <a href="Following_an_update_site" title="Following an update site">can be found there</a>.
</p><p>Once the update site is installed, restart ImageJ. A new menu, SCF, should appear. The Interactive Watershed plugin can be found in the menu <i>SCF&gt;Labelling&gt;Interactive H_Watershed</i>.
</p>
<h2><span class="mw-headline" id="User_Interface">User Interface</span></h2>
<p>To use the Interactive Watershed plugin.
</p>
<ol><li> Open an image to analyze. If the image has multiple channels or time points crop out a single channel/time point. the plugin focus on analyzing 2D and 3D images.</li>
<li> In the menu <i>SCF&gt;Labelling</i> click the item <i>Interactive H_Watershed</i>. The plugin will be initialized with the image that is in focus. A full watershed of the image is then performed. If the image is large a process dialog will pop up indicating the remaining time. If necessary the process can be interrupted. In such case you can crop a smaller volume and restart. </li>
<li> 2 windows will popup after the initialization: the watershed image and the control panel. When the control panel modified the watershed image is instantly updated. When satisfied with the segmentation press the export button to create a label map image.</li></ol>
<p>The control panel items, see Figure 4, can be used to modify the segmentation and its visualization. Their usage are described in the rest of the section:
</p>
<ul><li> <b>Analyzed image</b>: This is the name of the analyzed image. It is there for the user information</li>
<li> <b>Segmentation parameters</b>:
<ul><li> <b>Seed dynamics</b>: The slider allows to adjust the H-maxima selection. Increasing that value will merge regions, while decreasing it will split regions. Note that the value shown at the end of the line is not the actual <img class="mwe-math-fallback-image-inline tex" alt="H" src="_images/math/c/1/d/c1d9f50f86825a1a2302ec2449c17196.png" /> but <img class="mwe-math-fallback-image-inline tex" alt="log(1+H)" src="_images/math/1/6/c/16c1158a60e261d9f8072dff8aa9b1e2.png" />. The reason is that logarithm scale provides a more intuitive interaction (many merging happen at low <img class="mwe-math-fallback-image-inline tex" alt="H" src="_images/math/c/1/d/c1d9f50f86825a1a2302ec2449c17196.png" /> but much fewer at large <img class="mwe-math-fallback-image-inline tex" alt="H" src="_images/math/c/1/d/c1d9f50f86825a1a2302ec2449c17196.png" />.</li>
<li> <b>Intensity threshold</b>: The slider allows to select the watershed stopping criteria, <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" />. Increasing <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" /> decreases regions size while decreasing <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" /> till they eventually disappear. Note that the value shown at the end of the line is not the actual <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" /> but <img class="mwe-math-fallback-image-inline tex" alt="log(1+T)" src="_images/math/0/f/d/0fd02e6445505cd8097c75dbae6a1ee8.png" />. Logarithmic scale provides a more intuitive interaction as regions usually evolve fast for low <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" /> but much slower for larger <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" />.</li>
<li> <b>Peak flooding</b>: this parameter is an alternative way to explore regions thresholds. Rather than using a global threshold one can apply distinct thresholds to each segment. Peak flooding allows to flood each peak till a certain percentage of its height. For the region <img class="mwe-math-fallback-image-inline tex" alt="i" src="_images/math/8/6/5/865c0c0b4ab0e063e5caa3387c1a8741.png" /> the threshold <img class="mwe-math-fallback-image-inline tex" alt="T_i = T + \alpha/100 . (Imax_i-T)" src="_images/math/f/4/7/f47b74d55c9da1908aefd4549c737482.png" />, where <img class="mwe-math-fallback-image-inline tex" alt="T" src="_images/math/b/9/e/b9ece18c950afbfa6b0fdbfa4ff731d3.png" /> is the threshold parameter, <img class="mwe-math-fallback-image-inline tex" alt="\alpha" src="_images/math/b/c/c/bccfc7022dfb945174d9bcebad2297bb.png" /> is the peak flooding in percent and <img class="mwe-math-fallback-image-inline tex" alt="Imax_i" src="_images/math/6/6/8/668ecbeeb4a3d67f4ef795bd0aad3415.png" /> is the maximum intensity in region <img class="mwe-math-fallback-image-inline tex" alt="i" src="_images/math/8/6/5/865c0c0b4ab0e063e5caa3387c1a8741.png" />.  </li>
<li> <b>Allow Splitting</b>: if checked, playing with threshold or peak flooding might create new region by splitting existing one. If <i>allow splitting</i> is not checked the no new region is created, only the peak with the highest maxima is kept. </li></ul></li></ul>
<ul><li> <b>Display Parameters</b>:
<ul><li> <b>Display style</b> decides how the current segmentation is displayed. The different modes are illustrated in Figure 5.
<ul><li> <i>Image</i> will show directly the label map of the segmentation. This mode is convenient to adjust the segmentation display control and look up table with imageJ usual tools.</li>
<li> <i>Contour overlay</i> mode overlays regions contours to a background image (by default the analyzed image). This mode is very convenient to check that the regions shape match object shape in the raw data.</li>
<li> <i>Solid overlay</i> mode overlays solid segment to the background image. </li></ul></li>
<li> <b>Slicing axis</b>: If the analyzed image is 3D the user can select the orientation of the result visualization. Selecting <i>X</i> will slice the data in the plane perpendicular to the X axis (the plane YZ). As the resolution of microscopy data is often lower in the Z dimension and might be the bottleneck for segmentation quality it is important to check segmentation quality in plane XZ and YZ. The choice of slicing axis is illustrated in figure 6. By default the result window show XY planes. Navigation through the planes is done with usual ImageJ controls (image slider, mouse wheel, arrows).</li>
<li> <b>View Image</b> selects the background image (i.e. shown below the segmentation overlay). By default, it is the image that was segmented, but can also be set to any other image with the same dimension. Note that images can't be added to the list after plugin initialization. This feature is practical to compare region shape to the original data. For instance, if the segmentation was done on a filtered image that could have alter object shape (see figure 7).</li></ul></li>
<li> <b>Export regions mask</b>: if checked the export button will export a binary image rather than a label image. if the image is 2D this binary image is compatible with the particle analyzer from ImageJ.</li>
<li> <b>Export</b>: Once satisfied with the segmentation visible on screen the corresponding label map can be exported to an ImagePlus that can be further analyzed with ImageJ. The export action appear in the macro recorder for Image Macro Language and Jython language.</li></ul>
<p><br />
</p>
<div class="center"><div class="floatnone"><a href="./File:Figure_IWS_controlPanel.PNG" class="image"><img alt="Figure IWS controlPanel.PNG" src="_images/a/a3/Figure_IWS_controlPanel.PNG" width="800" height="294" /></a></div></div>
<div align="center"><b>Figure 4</b> shows the user interface of the Interactive Watershed plugin for 2D images (Left) and 3D images (Right). At the top of the panel, one can see the name of the analyzed image (Red). Below are parameters input, H value (Green), watershed threshold, T,(Blue) and peak Flooding (Orange). The control of segmentation display are: display style(Light purple) and the background image (Yellow). Finally the export button (Lilac) exports a label map corresponding to the current parameter H,T and peak flooding. User interface for 3D images also allows to select the slice orientation of the result window(Pink). Plane can be navigated directly with usual ImageJ controls.</div>
<p><br />
</p>
<div class="center"><div class="floatnone"><a href="./File:Figure_IWS_visualisationMode.PNG" class="image"><img alt="Figure IWS visualisationMode.PNG" src="_images/8/82/Figure_IWS_visualisationMode.PNG" width="800" height="320" /></a></div></div>
<div align="center"><b>Figure 5</b> is illustrating segmentation display modes. The second row shows a close up (red region from the first row). The raw data (1st column) are segmented by the Interactive Watershed plugin and can be displayed as a label map (2nd column),  regions contours overlay(column 3) and solid region overlay (column 4).</div>
<p><br />
</p>
<div class="center"><div class="floatnone"><a href="./File:Figure_IWS_sideViews_v2.PNG" class="image"><img alt="Figure IWS sideViews v2.PNG" src="_images/a/af/Figure_IWS_sideViews_v2.PNG" width="800" height="297" /></a></div></div>
<div align="center"><b>Figure 6:</b> In 3D images a good assessment of segmentation requires to observe data in different orientation. Beside the usual XY view of the data (Left), the Interactive Watershed plugin can display YZ sections (Center panel, section along the red line) and XZ sections (Right panel, section along the green line). If the data are not istropic the views are resampled to remove distortion and make inspection effortless.</div>
<p><br />
</p>
<div class="center"><div class="floatnone"><a href="./File:Figure_IWS_customBgImage.PNG" class="image"><img alt="Figure IWS customBgImage.PNG" src="_images/5/5e/Figure_IWS_customBgImage.PNG" width="800" height="257" /></a></div></div>
<div align="center"><b>Figure 7</b> illustrates the possibility to change the background image. When performing a segmentation on a filtered image (Left panel), One can select a background image (center panel, blue) different from the image processed (center panel, green), for instance to assess segmentation quality against raw data (Right Panel).</div>
<h2><span class="mw-headline" id="Scripting">Scripting</span></h2>
<p>In ImageJ macro language one can perform a H-Watershed segmentation with the following command:
</p><p><b><a rel="nofollow" class="external text" href="https://github.com/mpicbg-scicomp/Interactive-H-Watershed/blob/master/scripts/macro_IJ1.ijm">scripts/macro_IJ1.ijm</a></b>
</p>
<pre class="brush:plain">
hMin = 20;
thresh = 100;
peakFlooding = 90;
run("H_Watershed", "impin=["+getTitle()+"] hmin="+hMin+" thresh="+thresh+" peakflooding="+peakFlooding + " outputmask=true allowsplitting=false");</pre>
<p>In a Jython script the H-Watershed segmentation could be called as follows:
</p><p><b><a rel="nofollow" class="external text" href="https://github.com/mpicbg-scicomp/Interactive-H-Watershed/blob/master/scripts/jython_Ops.py">scripts/jython_Ops.py</a></b>
</p>
<pre class="brush:python"># @ImagePlus imp
# @OpService ops
# @UIService ui

# The parameters "Seed Dynamics", "Intensity threshold" and "peak flooding" can be made optional
# function Signature
# 	resultImage = op.run("H_Watershed", inputImage, hMin, threshold, peakFlooding, outputMask, allowSplitting)
#	all parameters beyond inputImage are optionnal mean they can be replaced by null or if at the end of the
#	list they can be remove completely. if the parameter is detected as missing a sensible default is used
#	hMin = 5(max-min)/100
#	threshold = min
# 	peakflooding = 100
#	outputMask = false (default is to output a label image)
#	allowsplitting = true (default is to allow threshold to create new peaks)

hMin = 0
thresh = 100
peakFlooding = 50

result0 = ops.run("H_Watershed", imp)

result1 = ops.run("H_Watershed", imp, hMin)

result2 = ops.run("H_Watershed", imp, hMin, thresh)

outputMask = True
allowSplit = False
result3 = ops.run("H_Watershed", imp, hMin, thresh, peakFlooding, outputMask, allowSplit )

ui.show(result0)
ui.show(result1)
ui.show(result2)
ui.show(result3)

</pre>
<p>The run commands are also recorded by the macro recorder when exporting a label map.
</p>
<h1><span class="mw-headline" id="Methods_and_Implementation">Methods and Implementation</span></h1>
<p>The plugin strategy is to do the heavy lifting once at the beginning and rely on it later on to keep segmentation update lightweight.
</p>
<h2><span class="mw-headline" id="Heavy_lifting">Heavy lifting</span></h2>
<p>At initialization the plugin calculates the full watershed of the image (i.e. for all local maxima of the image). This initial segmentation is then organized in a bottom up fashion. The segments are gradually merged to form a hierarchy (or a tree if you prefer). First the segment whose maxima have the lowest dynamics (or lowest robustness, remember H-maxima) are merged. When 2 segments are merged their dynamics and the dynamics of the neighbor segments are reevaluated. This merging process is repeated until all the segments are merged. It generates a tree whose nodes corresponds to segments in the image. In particular, when going along a tree branch, from leafs to root, the dynamics of the nodes is always increasing.
</p><p>As a result of this process we obtain a label map of the full watershed and a tree representing the merging of the regions in that label map.
</p>
<h2><span class="mw-headline" id="Ligthweight_update_of_the_segmentation">Ligthweight update of the segmentation</span></h2>
<p>When the H parameter is updated to a value <img class="mwe-math-fallback-image-inline tex" alt="h" src="_images/math/2/5/1/2510c39011c5be704182423e3a695e91.png" />. It means that the watershed should show only the segments which local maxima have a dynamics superior to <img class="mwe-math-fallback-image-inline tex" alt="h" src="_images/math/2/5/1/2510c39011c5be704182423e3a695e91.png" />. If we prune our full tree to remove all nodes with dynamics inferior to <img class="mwe-math-fallback-image-inline tex" alt="h" src="_images/math/2/5/1/2510c39011c5be704182423e3a695e91.png" /> the leaf of the pruned tree correspond to the segments we are looking for. We now need to recolor the label map of the full watershed to create a label map of the segmentation with <img class="mwe-math-fallback-image-inline tex" alt="h" src="_images/math/2/5/1/2510c39011c5be704182423e3a695e91.png" />-maxima. This can be done by attributing a label to the leaf node of the pruned tree. This label is then propagated to the leaf nodes of the original tree. Finally, the segment of the full watershed can be recolored according to this new label. This whole process is quite efficient: the relabelling is a simple raster pass on the orignal label map and the tree number of nodes is a lot smaller than the number of pixel in the image.
</p><p>When the T parameter is updated the maxima are not modified, thus it is only needed to go through the label map and check if the pixel value in the raw data is above or bellow the threshold. When the peak flooding parameter is changed the strategy is similar but each segment as a distinct threshold
</p>
<h2><span class="mw-headline" id="Comment_on_implementation">Comment on implementation</span></h2>
<p>The initial description, to the best of our knowledge of a watershed segment hierarchy using peak dynamics as a merging criteria was described in [Najman 1996]. The plugin initial watersheding is implemented after the IFT-watershed [Lotufo 2000]. The implementation was modified to build the segment tree on the fly. The plugin input and output are IJ1 imagePlus however the image processing inside the plugin relies on ImgLib2. A quick note on the segmentation update of 3D image, the plugin does not relabel the whole volume at every update but only the slice vizualized in order to preserve interactivity.
</p>
<h1><span class="mw-headline" id="References">References</span></h1>
<p><b>[Vincent 1991]</b> Vincent, L., &amp; Soille, P. (1991). Watersheds in digital spaces: an efficient algorithm based on immersion simulations. IEEE transactions on pattern analysis and machine intelligence, 13(6), 583-598.
</p><p><b>[Najman 1996]</b> Najman, L., &amp; Schmitt, M. (1996). Geodesic saliency of watershed contours and hierarchical segmentation. IEEE Transactions on pattern analysis and machine intelligence, 18(12), 1163-1173.
</p><p><b>[Lotufo 2000]</b> Lotufo, R., &amp; Falcao, A. (2000). The Ordered Queue And The Optimality Of The Watershed Approaches. In In Mathematical Morphology and its Applications to Image and Signal Processing.
</p><p><br />
</p>
<h1><span class="mw-headline" id="History">History</span></h1>
<p>History of version available of SCF_MPI_CBG update site
</p>
<ul><li> 2017-05-11: version 1.0.0
<ul><li> inital release</li></ul></li></ul>
<ul><li> 2017-06-12: version 1.0.1 ,
<ul><li> features: smoother slider for threshold and seeds</li>
<li> bugFix: correct initialisation of the segmentation in the script call (this correction suppress discrepency between the GUI and the script call)</li></ul></li></ul>
<ul><li> 2017-07-03: version 1.0.2
<ul><li> feature: the labelling is always continuous from 1 to number of labels in the image/volume</li>
<li> feature: threshold and seeds dynmics slider range fix to [0,1000] with step of 1</li>
<li> bugFix: the exported label map shows the correct number of labels in its title</li>
<li> bugfix: threshold value in in output title corrected</li></ul></li></ul>
<ul><li> 2017-08-16: version 1.0.4
<ul><li> feature: in scripting the parameter are optionnal (defaults, thresh = min , seed dynamics = 0.05*(Max-Min) , peakFlooding = 100). See <a rel="nofollow" class="external text" href="https://github.com/mpicbg-scicomp/Interactive-H-Watershed/blob/master/scripts/jython_Ops.py">jython script on the project repository</a> for usage details.</li>
<li> bugfix: the output image is not a virtual stack anymore. That was annoying for further analysis of the regions.</li>
<li> bugfix: The output image now the same calibration as the input</li></ul></li></ul>
<ul><li> 2017-08-17: version 1.0.5
<ul><li> bugfix: correct a regression with the macro recording.</li></ul></li></ul>
<ul><li> 2017-09-21: version 1.1.0
<ul><li> Add the possibility to export a mask that can be directly analyzed with the particle analyzer. the run(...) or IJ.run(...) were updated to reflect the additional parameter</li></ul></li></ul>
<ul><li> 2018-01-10: version 1.2.1
<ul><li> this version corrects a long standing bug such that object could be splitter by changing threshold  while the 2 new region kept the same labeling. now the new regions are either relabeled either only the highest remaining region is kept. the choice is made depending on allow splitting parameter.</li>
<li> the exported image is not a virtual stack anymore avoiding issue with further processing</li>
<li> the exported image name is also updated the reflect more faithfully the name of the input image</li>
<li> the threshold and seed slider are now linear: as a result the value displayed in the user interface is directly related to image intensity. which make parameter reading easier.</li></ul></li></ul>

<!-- 
NewPP limit report
Cached time: 20200713072734
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.092 seconds
Real time usage: 1.448 seconds
Preprocessor visited node count: 461/1000000
Preprocessor generated node count: 1643/1000000
Post‐expand include size: 2014/2097152 bytes
Template argument size: 1057/2097152 bytes
Highest expansion depth: 10/40
Expensive parser function count: 0/3
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00% 1384.303      1 - -total
 98.63% 1365.314      2 - Template:GitHubEmbed
  0.42%    5.775      1 - Template:Infobox
  0.29%    4.049      3 - Template:GitHub
-->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="index.php?title=Interactive_Watershed&amp;oldid=38303">http://imagej.net/index.php?title=Interactive_Watershed&amp;oldid=38303</a>"</div>
							</div>

			<div id="footer">
				<p> This page was last modified on 10 August 2018, at 05:37.</p><ul><li><a href="./ImageJ:Privacy_policy" title="ImageJ:Privacy policy">Privacy policy</a></li><li><a href="./ImageJ:About" class="mw-redirect" title="ImageJ:About">About ImageJ</a></li><li><a href="Imprint" title="Imprint">Imprint</a></li></ul>			</div>

			<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="./Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="./Category:Plugins" title="Category:Plugins">Plugins</a></li><li><a href="./Category:Segmentation" title="Category:Segmentation">Segmentation</a></li></ul></div></div>		</div>

		<div id="bottom-wrap">
			<div id="footer-wrap-inner">
				<div id="ternary" class="footer">
					<ul>
						<li class="widget">
							<img id="logo" src="skins/imagej-128.png" alt="">
						</li>
					</ul>
				</div>
			</div>
		</div>
		<script>(window.RLQ=window.RLQ||[]).push(function(){mw.loader.load(["ext.fancytree","ext.suckerfish","mediawiki.toc","mediawiki.action.view.postEdit","site","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","ext.SimpleTooltip"]);});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":1638});});</script>
		</body>
		</html>
		